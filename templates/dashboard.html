<!DOCTYPE html>
<!-- GOLD MASTER v5.0 - SAFE-START ONBOARDING + MOVE TO TRASH PHILOSOPHY -->
<html lang="en" class="dark" data-provider="{{ primary_provider|default('gmail') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- NUCLEAR CACHE BUST v4.0 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MailRemover - Command Center</title>
    <!-- StreamHub Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/tailwind.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'Consolas', 'monospace']
                    },
                    colors: {
                        /* StreamHub Sovereign Theme */
                        primary: { 400: '#39FF14', 500: '#32E012', 600: '#2BC710', 700: '#24AE0E' },
                        dark: { 800: '#1A1A24', 850: '#12121A', 900: '#0A0A0F', 950: '#050508' },
                        neon: { green: '#39FF14', glow: 'rgba(57, 255, 20, 0.15)' },
                        sovereign: { void: '#0A0A0F', panel: '#12121A', surface: '#1A1A24' }
                    }
                }
            }
        }
    </script>
    <style>
        /* ====== STREAMHUB SOVEREIGN THEME ====== */
        :root {
            /* Background Layers */
            --void: #0A0A0F;
            --panel: #12121A;
            --surface: #1A1A24;
            --surface-hover: #22222E;

            /* Borders */
            --border: #2A2A35;
            --border-hover: #3A3A45;

            /* Text */
            --text-primary: #F0F0F5;
            --text-secondary: #A0A0B0;
            --text-muted: #6A6A78;

            /* StreamHub Neon Green Accent */
            --neon-green: #39FF14;
            --neon-glow: rgba(57, 255, 20, 0.15);
            --neon-glow-strong: rgba(57, 255, 20, 0.3);

            /* Status Colors */
            --status-secure: #39FF14;
            --status-warning: #FFB800;
            --status-error: #FF4757;

            /* Legacy accent mapping for compatibility */
            --accent-primary: #39FF14;
            --accent-light: #5FFF42;
            --accent-dark: #2BC710;
            --accent-glow: rgba(57, 255, 20, 0.3);
        }
        /* Gmail Theme - Overlay accent only */
        [data-provider="gmail"] {
            --accent-primary: #EA4335;
            --accent-light: #F87171;
            --accent-dark: #DC2626;
            --accent-glow: rgba(234, 67, 53, 0.3);
        }
        /* Yahoo Theme */
        [data-provider="yahoo"] {
            --accent-primary: #6001D2;
            --accent-light: #8B5CF6;
            --accent-dark: #5000b0;
            --accent-glow: rgba(96, 1, 210, 0.3);
        }
        /* Outlook/Microsoft Theme */
        [data-provider="outlook"], [data-provider="microsoft"] {
            --accent-primary: #0078D4;
            --accent-light: #3B82F6;
            --accent-dark: #006cbe;
            --accent-glow: rgba(0, 120, 212, 0.3);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes countUp { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(-10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-100%); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes gaugePop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(0); opacity: 0; } }
        @keyframes textPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes glowPulse { 0%, 100% { filter: drop-shadow(0 0 8px var(--neon-glow-strong)); } 50% { filter: drop-shadow(0 0 20px var(--neon-green)); } }
        /* StreamHub Neon Pulse Animations */
        @keyframes pulse-neon { 0%, 100% { box-shadow: 0 0 4px var(--neon-green); } 50% { box-shadow: 0 0 12px var(--neon-green); } }
        @keyframes pulse-amber { 0%, 100% { box-shadow: 0 0 4px var(--status-warning); } 50% { box-shadow: 0 0 12px var(--status-warning); } }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 4px var(--status-error); } 50% { box-shadow: 0 0 12px var(--status-error); } }
        .pulse-neon { animation: pulse-neon 2s ease-in-out infinite; }
        .pulse-amber { animation: pulse-amber 1.5s ease-in-out infinite; }
        .pulse-red { animation: pulse-red 1s ease-in-out infinite; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .slide-in { animation: slideIn 0.25s ease-out forwards; }
        .slide-down { animation: slideDown 0.4s ease-out forwards; }
        .pop-in { animation: popIn 0.2s ease-out forwards; }
        .count-up { animation: countUp 0.25s ease-out forwards; }
        .gauge-pop { animation: gaugePop 0.4s ease-in-out forwards; }
        .text-pulse { animation: textPulse 1.2s ease-in-out infinite; }
        .glow-pulse { animation: glowPulse 1s ease-in-out infinite; }
        .stagger-1 { animation-delay: 0.03s; opacity: 0; }
        .stagger-2 { animation-delay: 0.06s; opacity: 0; }
        .stagger-3 { animation-delay: 0.09s; opacity: 0; }
        .stagger-4 { animation-delay: 0.12s; opacity: 0; }
        .stagger-5 { animation-delay: 0.15s; opacity: 0; }
        .stagger-6 { animation-delay: 0.18s; opacity: 0; }
        .sidebar-link { transition: all 0.15s; }
        .sidebar-link:hover { background: var(--neon-glow); }
        .sidebar-link.active { background: var(--neon-glow-strong); border-left: 3px solid var(--neon-green); }
        .filter-card { transition: all 0.15s; cursor: pointer; min-height: 2.75rem; }
        .filter-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 12px var(--neon-glow); border-color: var(--neon-green); }

        /* ====== PROFESSIONAL SHRINK - HIGH-DENSITY HORIZONTAL BARS ====== */
        /* ALL BREAKPOINTS: Sleek horizontal bars with Plumb Line alignment */
        .filter-grid {
            display: flex;
            flex-direction: column;
            gap: 0.25rem; /* Ultra-tight gaps */
        }
        .filter-compact {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.875rem; /* Tighter padding */
            min-height: 2.25rem; /* 36px compact bar */
            border-radius: 0.375rem;
        }
        .filter-compact .filter-left {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }
        .filter-compact .filter-icon {
            width: 1.25rem; /* 20px compact */
            height: 1.25rem;
            flex-shrink: 0;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .filter-compact .filter-name {
            font-size: 0.9375rem; /* 15px - readable */
            font-weight: 600;
            color: white;
        }
        .filter-compact .filter-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .filter-compact .filter-count {
            font-size: 1.125rem; /* 18px - BOLD & prominent */
            font-weight: 800;
            color: var(--neon-green);
            min-width: 3rem;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }
        .filter-compact .filter-thread-compare {
            font-size: 0.75rem; /* 12px - NO fine print */
            font-weight: 500;
            color: #9ca3af; /* Brighter gray */
            white-space: nowrap;
        }

        /* Tablet (≥640px): 2-column grid, still horizontal bars */
        @media (min-width: 640px) {
            .filter-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .filter-compact {
                padding: 0.75rem 1rem;
            }
            .filter-compact .filter-count {
                font-size: 1.25rem; /* 20px */
            }
        }

        /* Desktop (≥1024px): 3-column grid, STILL horizontal bars (no centering) */
        @media (min-width: 1024px) {
            .filter-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
            .filter-compact .filter-icon {
                width: 1.375rem; /* 22px */
                height: 1.375rem;
            }
            .filter-compact .filter-count {
                font-size: 1.375rem; /* 22px - DATA TRUTH prominent */
                font-weight: 800;
            }
            .filter-compact .filter-thread-compare {
                font-size: 0.8125rem; /* 13px */
            }
        }

        /* FORCE ORANGE INBOX */
        .inbox-icon-orange { background: rgba(255, 152, 0, 0.15) !important; }
        .inbox-icon-orange svg { color: #ff9800 !important; stroke: #ff9800 !important; }
        /* Plumb line container */
        .plumb-container { padding: 0 20px; }
        .sender-row { transition: background 0.1s; }
        .sender-row:hover { background: var(--neon-glow); }
        /* StreamHub Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--void); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
        * { scrollbar-width: thin; scrollbar-color: var(--border) var(--void); }
        .tooltip { position: relative; }
        .tooltip .tooltip-text {
            visibility: hidden; opacity: 0;
            position: absolute; z-index: 50;
            bottom: calc(100% + 8px); left: 0;
            background: #1f2937; color: #e5e7eb;
            padding: 10px 14px; border-radius: 8px;
            font-size: 12px; line-height: 1.4;
            width: 220px;
            border: 1px solid #374151;
            transition: opacity 0.15s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .count-badge { min-width: 2.5rem; transition: all 0.2s ease; }
        .count-badge.loading {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
            animation: shimmer 1.2s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        /* Sticky Safety Header - Mobile optimized */
        .sticky-safety-header {
            position: sticky; top: 0; z-index: 45;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem; /* Reduced on mobile */
        }
        @media (min-width: 640px) {
            .sticky-safety-header { padding: 0.75rem 1rem; }
        }
        .sticky-safety-header .safety-text { font-size: 0.75rem; }
        @media (min-width: 640px) {
            .sticky-safety-header .safety-text { font-size: 0.875rem; }
        }
        .safety-header-practice { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-bottom: 2px solid #60a5fa; }
        .safety-header-live { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); border-bottom: 2px solid #f87171; }
        /* ====== CHECKBOX-BASED UI - PLUMB LINE ALIGNED ====== */
        /* Fixed checkbox column width for perfect vertical alignment */
        :root { --checkbox-col: 40px; }
        .gm-row { display: flex; align-items: center; padding: 10px 12px; gap: 0; transition: background 0.2s; }
        /* Master checkbox - fixed width column, centered */
        .gm-master {
            width: var(--checkbox-col); flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        /* High-contrast checkboxes */
        .gm-checkbox {
            width: 18px; height: 18px; cursor: pointer;
            accent-color: #ef4444; margin: 0;
        }
        .gm-checkbox-keep { accent-color: #22c55e; }
        /* Sender Info - starts immediately after checkbox column */
        .gm-sender { display: flex; align-items: center; flex: 1; min-width: 0; cursor: pointer; padding-left: 8px; }
        .gm-sender:hover .gm-email { color: #a78bfa; }
        .gm-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: white; flex-shrink: 0; }
        .gm-info { margin-left: 10px; flex: 1; min-width: 0; }
        .gm-email { font-size: 14px; color: #e5e7eb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 0.15s; }
        .gm-count { font-size: 12px; color: #9ca3af; } /* More readable - lighter gray */
        .gm-expand { color: #6b7280; margin-left: 6px; flex-shrink: 0; transition: transform 0.2s; }
        .gm-expand.open { transform: rotate(180deg); }
        /* Status summary on right */
        .gm-summary { flex-shrink: 0; text-align: right; font-size: 12px; color: #6b7280; min-width: 80px; padding-right: 4px; }
        .gm-summary-remove { color: #f87171; }
        .gm-summary-keep { color: #4ade80; }
        .gm-summary-mixed { color: #fbbf24; }
        /* Row backgrounds based on state */
        .gm-row-remove { background: rgba(239, 68, 68, 0.08); border-left: 3px solid #ef4444; }
        .gm-row-keep { background: rgba(34, 197, 94, 0.08); border-left: 3px solid #22c55e; }
        .gm-row-mixed { background: rgba(251, 191, 36, 0.05); border-left: 3px solid #fbbf24; }
        /* Message rows - TIGHT LAYOUT with VISIBLE BUTTONS on FAR LEFT */
        .gm-msg {
            display: flex !important;
            align-items: center !important;
            padding: 6px 8px !important;
            gap: 0 !important;
            border-bottom: 1px solid rgba(55, 65, 81, 0.3) !important;
            transition: all 0.1s ease !important;
            min-height: 50px !important;
            max-width: 100% !important;
            overflow: hidden !important;
        }
        .gm-msg:last-child { border-bottom: none; }
        .gm-msg:hover { background: rgba(255, 255, 255, 0.02); }

        /* ====== ROW BACKGROUNDS - SUBTLE TINT ONLY ====== */
        .gm-msg-remove { background: rgba(239, 68, 68, 0.08); }
        .gm-msg-keep { background: rgba(34, 197, 94, 0.08); }

        /* ====== INDENTED MESSAGE LIST - separated from main senders ====== */
        .message-list {
            margin-left: 180px; /* Indent expanded emails to the right */
            border-left: 2px solid #374151;
            padding-left: 12px;
        }

        /* ====== MINIMAL CHECKBOX DESIGN ====== */
        /* Checkboxes RIGHT NEXT to email content - not far right */
        .gm-msg-controls {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            padding: 0 8px;
        }

        /* Plain checkbox - no labels, color fill on check */
        .plain-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            border: 2px solid #6b7280;
            border-radius: 3px;
            background: transparent;
            transition: all 0.15s ease;
            position: relative;
        }
        .plain-checkbox:hover {
            border-color: #9ca3af;
        }
        /* Trash checkbox - fills RED when checked */
        .plain-checkbox.trash-check:checked {
            background: #ef4444;
            border-color: #ef4444;
        }
        .plain-checkbox.trash-check:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        /* Safe checkbox - fills GREEN when checked */
        .plain-checkbox.safe-check:checked {
            background: #22c55e;
            border-color: #22c55e;
        }
        .plain-checkbox.safe-check:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Status text on FAR RIGHT - LARGE and COLORED */
        .msg-status {
            font-size: 14px;
            font-weight: 700;
            min-width: 80px;
            text-align: right;
            padding-left: 12px;
        }
        .msg-status.status-trash { color: #f87171; }
        .msg-status.status-safe { color: #4ade80; }
        .msg-status.status-none { color: #4b5563; }

        /* Message content - compact, controls stay close */
        .gm-msg-content {
            display: flex !important;
            align-items: center !important;
            min-width: 0 !important;
            padding-left: 10px !important;
            gap: 8px !important;
            overflow: hidden !important;
            flex: 1;
            max-width: 500px; /* Limit width so controls stay close */
        }
        .gm-msg-content > span.truncate {
            flex: 1 !important;
            min-width: 0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        /* ====== PREVIEW BUTTON - next to email ====== */
        .preview-btn {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid #4b5563;
            border-radius: 4px;
            color: #9ca3af;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.15s ease;
            white-space: nowrap;
            cursor: pointer;
            flex-shrink: 0;
        }
        .preview-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #6b7280;
            color: white;
        }
        /* Fast transitions */
        * { -webkit-tap-highlight-color: transparent; }
        button, a, input, .filter-card { touch-action: manipulation; }

        /* ====== LAYOUT CONTAINMENT - NO BLEEDING ====== */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        main {
            overflow-x: hidden;
        }
        .containment-wrapper {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* ====== VAULT CONTAINER STYLING ====== */
        .vault-container {
            position: relative;
            z-index: 10;
        }
        /* Ensure vault is visible over search overlay when needed */
        @keyframes vaultGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3), 0 4px 20px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.5), 0 4px 30px rgba(0,0,0,0.4); }
        }
        .vault-container:hover {
            animation: vaultGlow 2s ease-in-out infinite;
        }
        /* Sanctuary modal dark theme */
        #vault-sanctuary-modal .bg-dark-950\/90 {
            background: rgba(10, 10, 15, 0.95);
        }
        /* Protected keyword badge animation */
        @keyframes protectedPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        [data-protected-keyword]:not([data-protected-keyword=""]) .text-amber-400 {
            animation: protectedPulse 2s ease-in-out infinite;
        }

        /* ====== MODE TOGGLE - HIGH CONTRAST (Gray/Red) ====== */
        .mode-control-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; /* SAME as .gm-row for alignment */
            background: #1f2937;
            border-bottom: 3px solid #374151;
            transition: all 0.3s ease;
        }
        .mode-control-bar.live-mode {
            background: #dc2626;
            border-bottom-color: #f87171;
        }
        /* LEFT SIDE: Checkbox column + helper text (matches email row structure) */
        .control-left {
            display: flex; align-items: center; gap: 0;
        }
        /* Select All checkbox - SAME width as .gm-master for plumb line */
        .select-all-col {
            width: var(--checkbox-col); flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .select-all-checkbox {
            width: 18px; height: 18px; cursor: pointer;
            accent-color: white; margin: 0;
        }
        /* Helper text - starts where sender info starts (after checkbox col + 8px padding) */
        .control-helper {
            padding-left: 8px; /* matches .gm-sender padding-left */
            font-size: 13px; color: rgba(255,255,255,0.7);
        }
        /* RIGHT SIDE: Toggle + Button flush right */
        .control-right {
            display: flex; align-items: center; gap: 12px;
        }
        /* The actual toggle switch */
        .mode-toggle-container {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px; background: rgba(0,0,0,0.3);
            border-radius: 6px; cursor: pointer; user-select: none;
        }
        .mode-toggle-container:hover { background: rgba(0,0,0,0.4); }
        .mode-toggle-label { font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; }
        .mode-toggle-label.inactive { opacity: 0.4; }
        /* HTML Checkbox Toggle */
        .toggle-checkbox { display: none; }
        .toggle-slider {
            position: relative; width: 44px; height: 24px;
            background: #4b5563; border-radius: 12px;
            transition: background 0.3s ease;
        }
        .toggle-slider::after {
            content: ''; position: absolute;
            top: 3px; left: 3px; width: 18px; height: 18px;
            background: white; border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .toggle-checkbox:checked + .toggle-slider { background: #ef4444; }
        .toggle-checkbox:checked + .toggle-slider::after { transform: translateX(20px); }
        /* Execute button */
        .execute-btn {
            padding: 8px 16px; font-size: 13px; font-weight: 700;
            border-radius: 6px; transition: all 0.15s;
            display: flex; align-items: center; gap: 6px;
        }
        .execute-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* Selection count */
        .selection-count { font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 600; }

        /* ============ GAS GAUGE SPEEDOMETER ============ */
        .gauge-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .gauge-overlay.hidden { display: none !important; }
        .gauge-container {
            position: relative;
            width: 280px;
            height: 160px;
        }
        .gauge-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        .gauge-bg {
            fill: none;
            stroke: #1f2937;
            stroke-width: 20;
            stroke-linecap: round;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 20;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.4s linear, stroke 0.3s ease;
            filter: drop-shadow(0 0 10px currentColor);
        }
        /* Snap to 100% instantly when completing */
        .gauge-fill.completing {
            transition: stroke-dashoffset 0.35s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.2s ease;
        }
        /* Results reveal animation */
        @keyframes resultsReveal {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .results-reveal {
            animation: resultsReveal 0.4s ease-out forwards;
        }
        /* Staggered row fade-in */
        @keyframes rowFadeIn {
            from { opacity: 0; transform: translateX(-8px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .row-fade-in {
            opacity: 0;
            animation: rowFadeIn 0.3s ease-out forwards;
        }
        .gauge-ticks {
            fill: none;
            stroke: #374151;
            stroke-width: 2;
        }
        .gauge-needle {
            fill: #e5e7eb;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            transform-origin: 140px 140px;
            transition: transform 0.4s linear;
        }
        .gauge-needle.completing {
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .gauge-center {
            fill: #1f2937;
            stroke: #4b5563;
            stroke-width: 3;
        }
        .gauge-percent {
            font-size: 48px;
            font-weight: 800;
            fill: white;
            text-anchor: middle;
        }
        .gauge-label {
            font-size: 14px;
            fill: #9ca3af;
            text-anchor: middle;
        }
        .gauge-status {
            margin-top: 24px;
            text-align: center;
        }
        .gauge-status-text {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        .gauge-status-sub {
            font-size: 14px;
            color: #9ca3af;
            margin-top: 4px;
        }
        /* Speed markers */
        .gauge-marker {
            font-size: 11px;
            fill: #6b7280;
            font-weight: 500;
        }

        /* ====== LABEL BADGES ====== */
        .label-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            border: 1px solid;
            white-space: nowrap;
            flex-shrink: 0;
        }
        /* Gmail Categories */
        .label-inbox { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-color: rgba(59, 130, 246, 0.3); }
        .label-promotions { background: rgba(34, 197, 94, 0.15); color: #4ade80; border-color: rgba(34, 197, 94, 0.3); }
        .label-social { background: rgba(168, 85, 247, 0.15); color: #c084fc; border-color: rgba(168, 85, 247, 0.3); }
        .label-updates { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); }
        .label-forums { background: rgba(236, 72, 153, 0.15); color: #f472b6; border-color: rgba(236, 72, 153, 0.3); }
        .label-spam { background: rgba(239, 68, 68, 0.15); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
        .label-trash { background: rgba(107, 114, 128, 0.15); color: #9ca3af; border-color: rgba(107, 114, 128, 0.3); }
        .label-sent { background: rgba(20, 184, 166, 0.15); color: #2dd4bf; border-color: rgba(20, 184, 166, 0.3); }
        .label-draft { background: rgba(249, 115, 22, 0.15); color: #fb923c; border-color: rgba(249, 115, 22, 0.3); }
        .label-starred { background: rgba(234, 179, 8, 0.15); color: #facc15; border-color: rgba(234, 179, 8, 0.3); }
        .label-important { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border-color: rgba(245, 158, 11, 0.3); }
        .label-default { background: rgba(75, 85, 99, 0.15); color: #9ca3af; border-color: rgba(75, 85, 99, 0.3); }

        /* ====== HIGH-VELOCITY ANIMATION SYSTEM v1.0 ====== */
        /* Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            .vortex-item, .implode-item, .vault-item,
            .vortex-container, .implode-container, .vault-container {
                animation: none !important;
                transition: opacity 0.15s ease !important;
            }
        }

        /* Animation settings toggle - when disabled */
        .animations-disabled .vortex-item,
        .animations-disabled .implode-item,
        .animations-disabled .vault-item {
            animation: none !important;
            transition: opacity 0.15s ease !important;
        }

        /* ====== VORTEX ANIMATION (TRASH ACTION) ====== */
        /* Fast swirling spiral INTO destruction - 300-500ms */
        @keyframes vortexSpiral {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg) scale(1);
                filter: blur(0px);
            }
            30% {
                opacity: 0.9;
                transform: translate(calc(var(--vortex-x) * 0.3), calc(var(--vortex-y) * 0.3)) rotate(180deg) scale(0.8);
                filter: blur(1px);
            }
            60% {
                opacity: 0.6;
                transform: translate(calc(var(--vortex-x) * 0.7), calc(var(--vortex-y) * 0.7)) rotate(540deg) scale(0.4);
                filter: blur(2px);
            }
            100% {
                opacity: 0;
                transform: translate(var(--vortex-x), var(--vortex-y)) rotate(1080deg) scale(0);
                filter: blur(4px);
            }
        }

        .vortex-item {
            animation: vortexSpiral 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
            pointer-events: none;
            will-change: transform, opacity, filter;
        }

        /* Vortex center point visual */
        .vortex-center {
            position: fixed;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(239, 68, 68, 0.8) 0%, rgba(234, 88, 12, 0.6) 40%, transparent 70%);
            box-shadow: 0 0 60px 30px rgba(239, 68, 68, 0.4),
                        0 0 100px 60px rgba(234, 88, 12, 0.2),
                        inset 0 0 30px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%) scale(0);
            z-index: 9998;
            pointer-events: none;
            will-change: transform;
        }

        @keyframes vortexCenterPulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }

        .vortex-center.active {
            animation: vortexCenterPulse 0.5s ease-out forwards;
        }

        /* Vortex particle trails */
        .vortex-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #ef4444;
            pointer-events: none;
            z-index: 9997;
            will-change: transform, opacity;
        }

        @keyframes vortexParticle {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        /* ====== IMPLOSION ANIMATION (BULK DELETE) ====== */
        /* Even faster collapse toward center - 200-400ms with fragments */
        @keyframes implodeCollapse {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
                filter: brightness(1);
            }
            40% {
                opacity: 0.8;
                transform: translate(calc(var(--implode-x) * 0.5), calc(var(--implode-y) * 0.5)) scale(0.6);
                filter: brightness(1.5);
            }
            70% {
                opacity: 0.5;
                transform: translate(calc(var(--implode-x) * 0.85), calc(var(--implode-y) * 0.85)) scale(0.2);
                filter: brightness(2);
            }
            100% {
                opacity: 0;
                transform: translate(var(--implode-x), var(--implode-y)) scale(0);
                filter: brightness(3);
            }
        }

        .implode-item {
            animation: implodeCollapse 0.3s cubic-bezier(0.7, 0, 0.84, 0) forwards;
            pointer-events: none;
            will-change: transform, opacity, filter;
        }

        /* Implosion shockwave */
        .implode-shockwave {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid rgba(239, 68, 68, 0.8);
            background: transparent;
            transform: translate(-50%, -50%) scale(0);
            z-index: 9998;
            pointer-events: none;
            will-change: transform, opacity;
        }

        @keyframes implodeShockwave {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; border-width: 6px; }
            100% { transform: translate(-50%, -50%) scale(8); opacity: 0; border-width: 1px; }
        }

        .implode-shockwave.active {
            animation: implodeShockwave 0.35s ease-out forwards;
        }

        /* Fragment particles for "crunch" effect */
        .implode-fragment {
            position: fixed;
            width: 6px;
            height: 6px;
            background: linear-gradient(135deg, #f87171 0%, #ef4444 50%, #dc2626 100%);
            pointer-events: none;
            z-index: 9999;
            will-change: transform, opacity;
        }

        @keyframes fragmentExplode {
            0% { opacity: 1; transform: translate(0, 0) scale(1) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--frag-x), var(--frag-y)) scale(0) rotate(720deg); }
        }

        /* ====== VAULT PROTECTION ANIMATION (SAVE ACTION) ====== */
        /* Float UP into safety with shield glow - 400ms */
        @keyframes vaultFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: drop-shadow(0 0 0 transparent);
            }
            30% {
                opacity: 1;
                transform: translateY(-10px) scale(1.02);
                filter: drop-shadow(0 0 10px rgba(34, 197, 94, 0.5));
            }
            60% {
                opacity: 0.9;
                transform: translateY(-30px) scale(0.95);
                filter: drop-shadow(0 0 20px rgba(34, 197, 94, 0.7));
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
                filter: drop-shadow(0 0 30px rgba(34, 197, 94, 0.9));
            }
        }

        .vault-item {
            animation: vaultFloat 0.4s ease-out forwards;
            pointer-events: none;
            will-change: transform, opacity, filter;
        }

        /* Vault shield effect */
        .vault-shield {
            position: fixed;
            width: 60px;
            height: 70px;
            pointer-events: none;
            z-index: 9998;
            transform: translate(-50%, -50%) scale(0);
            will-change: transform, opacity;
        }

        .vault-shield svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: #22c55e;
            stroke-width: 2;
            filter: drop-shadow(0 0 15px rgba(34, 197, 94, 0.8));
        }

        @keyframes vaultShieldPulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            30% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            70% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
        }

        .vault-shield.active {
            animation: vaultShieldPulse 0.5s ease-out forwards;
        }

        /* Green particles rising up */
        .vault-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #4ade80;
            pointer-events: none;
            z-index: 9997;
            will-change: transform, opacity;
        }

        @keyframes vaultParticleRise {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(0); }
        }

        /* ====== SELECTION FEEDBACK ====== */
        /* Subtle hover highlight - instant response */
        .email-row-selectable {
            transition: background-color 0.1s ease, border-color 0.1s ease;
        }

        .email-row-selectable:hover {
            background-color: var(--neon-glow);
        }

        /* Selected state - visible indicator */
        .email-row-selected {
            background-color: rgba(239, 68, 68, 0.12) !important;
            border-left: 3px solid #ef4444 !important;
        }

        .email-row-saved {
            background-color: rgba(34, 197, 94, 0.12) !important;
            border-left: 3px solid #22c55e !important;
        }

        /* Checkbox instant state change */
        .instant-check {
            transition: none !important;
        }

        /* Animation container overlay */
        .animation-overlay {
            position: fixed;
            inset: 0;
            z-index: 9996;
            pointer-events: none;
            overflow: hidden;
        }

        /* Settings toggle for animations */
        .animation-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            font-size: 12px;
            color: #9ca3af;
        }

        .animation-toggle-container input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--neon-green);
        }
    </style>
</head>
<body class="min-h-screen flex font-sans" style="background: var(--void);">
    <!-- Sidebar (Desktop) - StreamHub Theme -->
    <aside class="w-64 bg-dark-900 border-r border-gray-800 flex flex-col fixed h-full z-40 hidden lg:flex" style="background: var(--panel); border-color: var(--border);">
        <div class="p-5 border-b" style="border-color: var(--border);">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: var(--neon-glow-strong); border: 1px solid var(--neon-green);">
                    <svg class="w-6 h-6" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div>
                    <span class="text-lg font-bold" style="color: var(--text-primary);">MailRemover</span>
                    <span class="block text-xs" style="color: var(--neon-green);">SOVEREIGN HUB</span>
                </div>
            </div>
            <!-- Privacy Badge - StreamHub Status -->
            <div class="mt-3 relative group cursor-help">
                <div class="flex items-center space-x-2 text-xs" style="color: var(--neon-green);">
                    <div class="w-2 h-2 rounded-full pulse-neon" style="background: var(--neon-green);"></div>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    <span class="font-semibold tracking-wide">SECURE</span>
                </div>
                <div class="absolute left-0 bottom-full mb-2 w-56 p-3 bg-gray-800 rounded-lg border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                    <p class="text-xs text-gray-300 leading-relaxed">No credit card info stored. No emails read. No data shared with third parties.</p>
                </div>
            </div>

            <!-- Why MailRemover? -->
            <div class="mt-4 pt-4 border-t border-gray-800">
                <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Why MailRemover?</h4>
                <div class="space-y-3">
                    <div class="flex items-start space-x-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        <div>
                            <p class="text-xs text-white font-medium">Privacy First</p>
                            <p class="text-xs text-gray-500">Everything runs in your session</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        <div>
                            <p class="text-xs text-white font-medium">No Data Stored</p>
                            <p class="text-xs text-gray-500">We cannot read or see your emails</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        <div>
                            <p class="text-xs text-white font-medium">30-Day Safety Net</p>
                            <p class="text-xs text-gray-500">Gmail keeps trash for recovery</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== ANIMATION SETTINGS ====== -->
            <div class="mt-4 pt-4 border-t border-gray-800">
                <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Visual Effects</h4>
                <label class="flex items-center justify-between cursor-pointer group">
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <span class="text-xs text-gray-300 group-hover:text-white transition-colors">High-Velocity Animations</span>
                    </div>
                    <input type="checkbox" id="animation-toggle" class="w-4 h-4 accent-primary-500 cursor-pointer" checked onchange="if(window.AnimationSystem) AnimationSystem.toggle(this.checked)">
                </label>
                <p class="text-xs text-gray-500 mt-1 ml-6">Vortex & implosion effects on delete</p>
            </div>

            <!-- ====== CONNECTED PROVIDERS STRIP ====== -->
            <div class="mt-4 pt-4 border-t border-gray-800">
                <div class="flex items-center gap-2 mb-3">
                    <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Connected Accounts</h4>
                    <!-- Green dot legend -->
                    <div class="relative w-4 h-4">
                        <div class="w-4 h-4 rounded bg-gray-700/50 border border-gray-600"></div>
                        <span class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-green-500 rounded-full border border-dark-900"></span>
                    </div>
                </div>
                <div id="provider-strip" class="flex items-center space-x-2">
                    <!-- Gmail - shows active ring if primary -->
                    {% set gmail_connected = connected_providers|selectattr('name', 'equalto', 'gmail')|list|length > 0 %}
                    {% set gmail_is_primary = primary_provider == 'gmail' %}
                    <div class="provider-icon tooltip relative {% if gmail_is_primary %}ring-2 ring-primary-500 ring-offset-2 ring-offset-dark-900 rounded-lg{% endif %}" data-provider="gmail" onclick="switchProvider('gmail')">
                        <div class="w-8 h-8 rounded-lg bg-red-500/20 border-red-500/40 {% if gmail_connected %}cursor-pointer{% else %}cursor-pointer opacity-80{% endif %} border flex items-center justify-center transition-all hover:scale-105">
                            <svg class="w-4 h-4 {% if gmail_connected %}text-red-400{% else %}text-red-400/70{% endif %}" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/>
                            </svg>
                        </div>
                        {% if gmail_connected %}
                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-dark-900"></span>
                        {% endif %}
                        <span class="tooltip-text">Gmail {% if gmail_connected %}- Connected{% if gmail_is_primary %} (Active){% endif %}{% else %}- Click to connect{% endif %}</span>
                    </div>
                    <!-- Outlook/Microsoft (Middle - Working) -->
                    {% set outlook_connected = connected_providers|selectattr('name', 'equalto', 'outlook')|list|length > 0 or connected_providers|selectattr('name', 'equalto', 'microsoft')|list|length > 0 %}
                    {% set outlook_is_primary = primary_provider == 'outlook' or primary_provider == 'microsoft' %}
                    <a href="{% if not outlook_connected %}{{ url_for('auth_login', provider='microsoft') }}{% else %}#{% endif %}" class="provider-icon tooltip relative {% if outlook_is_primary %}ring-2 ring-primary-500 ring-offset-2 ring-offset-dark-900 rounded-lg{% endif %} transition-opacity" data-provider="microsoft" onclick="{% if outlook_connected %}switchProvider('microsoft'); return false;{% endif %}">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/20 border-blue-500/40 {% if outlook_connected %}{% else %}opacity-80{% endif %} border flex items-center justify-center cursor-pointer transition-colors hover:scale-105">
                            <svg class="w-4 h-4 {% if outlook_connected %}text-blue-400{% else %}text-blue-400/70{% endif %}" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 7.387v10.478c0 .23-.08.424-.238.576-.158.154-.352.23-.58.23h-8.547v-6.959l1.6 1.229c.1.086.215.127.344.127.125 0 .24-.041.342-.127l6.084-4.684c.094-.073.176-.13.244-.168.068-.04.15-.062.246-.062.195 0 .36.072.5.215.137.143.205.304.205.482v-.002 1.037zM14.635 7.387v-1.04c0-.215.063-.38.19-.496.125-.118.28-.176.463-.176h.232l5.932 4.572c.133.102.27.152.412.152.14 0 .275-.05.404-.152l5.932-4.572h.207c.18 0 .336.058.465.176.127.116.19.281.19.496v1.04l-6.578 5.062-6.579-5.062L14.904 0H0v18h9.387V7.387h5.248zm-8.158 8.145c-.627.664-1.424.996-2.387.996-1.023 0-1.851-.353-2.484-1.059s-.95-1.627-.95-2.762c0-1.207.327-2.172.98-2.895s1.512-1.084 2.574-1.084c.922 0 1.684.315 2.287.945.602.63.904 1.455.904 2.475v.88H3.41c.043.564.224 1.004.543 1.318.318.316.736.473 1.254.473.746 0 1.289-.34 1.629-1.02l1.309.66c-.59 1.135-1.56 1.703-2.908 1.703l.24.37zm-1.004-5.264c-.465 0-.844.137-1.139.414-.295.275-.486.67-.572 1.188h3.26c-.047-.51-.211-.906-.492-1.188s-.643-.414-1.057-.414z"/>
                            </svg>
                        </div>
                        {% if outlook_connected %}
                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-dark-900"></span>
                        {% endif %}
                        <span class="tooltip-text">Microsoft {% if outlook_connected %}- Connected{% if outlook_is_primary %} (Active){% endif %}{% else %}- Click to connect{% endif %}</span>
                    </a>
                    <!-- Yahoo (Right) - DISABLED / Coming Soon -->
                    <div class="provider-icon tooltip relative opacity-50 cursor-not-allowed" data-provider="yahoo" id="yahoo-provider-icon">
                        <div class="w-8 h-8 rounded-lg bg-purple-500/10 border-purple-500/20 border flex items-center justify-center">
                            <svg class="w-4 h-4 text-purple-400/50" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10.816 8.768l-4.2 6.632L2.4 8.768H0l5.6 8.832v6.4h3.2v-6.4L14.4 8.768h-3.584zm5.984 0L24 8.768h-3.6l-4.8 7.6 1.6 2.4 2.4-3.8 4.8 7.832h3.6l-7.2-11.232z"/>
                            </svg>
                        </div>
                        <span class="tooltip-text">Yahoo - Coming Soon</span>
                    </div>
                </div>
                <!-- Provider Switch Dropdown (shown when multiple providers connected) -->
                {% if connected_providers|length > 1 %}
                <div class="mt-3">
                    <label class="text-xs text-gray-500 block mb-1">Active Provider:</label>
                    <select id="provider-switcher" onchange="switchProvider(this.value)" class="w-full bg-dark-850 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-primary-500">
                        {% for provider in connected_providers %}
                        <option value="{{ provider.name }}" {% if provider.name == primary_provider %}selected{% endif %}>
                            {{ provider.name|capitalize }} ({{ provider.email }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="/dashboard" class="sidebar-link active flex items-center space-x-3 px-4 py-3 rounded-lg text-white">
                <svg class="w-5 h-5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"/>
                </svg>
                <span>Command Center</span>
            </a>
            <a href="/pricing" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                </svg>
                <span>Upgrade</span>
            </a>
            <!-- Membership Badge - Sidebar -->
            {% if user_tier in ['pro', 'lifetime', 'purge'] %}
            <div class="mx-2 mt-3 px-3 py-2 rounded-lg {% if user_tier == 'lifetime' %}bg-amber-500/10 border border-amber-500/30{% elif user_tier == 'purge' %}bg-primary-500/10 border border-primary-500/30{% else %}bg-green-500/10 border border-green-500/30{% endif %}">
                <p class="text-xs font-medium {% if user_tier == 'lifetime' %}text-amber-400{% elif user_tier == 'purge' %}text-primary-400{% else %}text-green-400{% endif %}">
                    {% if user_tier == 'lifetime' %}Lifetime - Unlimited{% elif user_tier == 'purge' %}Purge: {{ purge_days_remaining }}d left{% else %}Maintenance - Unlimited{% endif %}
                </p>
            </div>
            {% endif %}
            {% if not user_tier or user_tier == 'free' %}
            <div class="mt-6 mx-2 p-4 bg-gradient-to-br from-primary-600/20 to-purple-600/20 rounded-xl border border-primary-500/30">
                <p class="text-xs text-gray-400 mb-3">Unlimited inbox organizing.</p>
                <a href="/pricing" class="block w-full py-2 text-center text-sm bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors">
                    See Plans
                </a>
            </div>
            {% endif %}
        </nav>
        <div class="p-4 border-t border-gray-800">
            <p class="text-xs text-gray-400 mb-2">Welcome back, {{ user_display_name|default(user_email.split('@')[0]) }}</p>
            <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-dark));">
                    {{ user_email[0]|upper if user_email else '?' }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-white truncate">{{ user_email }}</p>
                    <p class="text-xs text-gray-500">
                        {% if user_tier == 'pro' %}Maintenance{% elif user_tier == 'purge' %}Purge: {{ purge_days_remaining }}d{% elif user_tier == 'lifetime' %}Lifetime{% else %}Free{% endif %}
                    </p>
                </div>
            </div>
            <a href="/logout" class="flex items-center justify-center space-x-2 w-full px-4 py-2 text-sm text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span>Sign Out</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-64">
        <!-- STICKY SAFETY HEADER (Mobile & Desktop) - StreamHub Status Banner -->
        <div id="safety-header" class="sticky-safety-header px-4 py-3 flex items-center justify-between shadow-lg" style="background: var(--panel); border-bottom: 1px solid var(--neon-green); box-shadow: inset 0 0 12px var(--neon-glow);">
            <div class="flex items-center space-x-3">
                <div id="safety-icon" class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: var(--neon-glow-strong);">
                    <div class="w-3 h-3 rounded-full pulse-neon" style="background: var(--neon-green);"></div>
                </div>
                <div>
                    <span id="safety-title" class="text-sm font-bold tracking-wide" style="color: var(--neon-green);">REVIEW MODE</span>
                    <p id="safety-desc" class="text-xs" style="color: var(--text-secondary);">Safe to explore - no emails deleted without confirmation</p>
                </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="practice-toggle" class="sr-only peer" checked>
                <div class="w-14 h-7 bg-white/30 rounded-full peer peer-checked:bg-white/30 after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-7"></div>
            </label>
        </div>

        <!-- Mobile Header - StreamHub Style -->
        <header class="lg:hidden p-4" style="background: var(--panel); border-bottom: 1px solid var(--border);">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: var(--neon-glow-strong); border: 1px solid var(--neon-green);">
                        <svg class="w-5 h-5" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8"/>
                        </svg>
                    </div>
                    <span class="font-bold" style="color: var(--text-primary);">MailRemover</span>
                </div>
                <a href="/logout" style="color: var(--text-muted);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-muted)'"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"/></svg></a>
            </div>
        </header>

        <div class="p-6 lg:p-8 max-w-6xl mx-auto">
            <!-- Page Header - StreamHub Style -->
            <div class="mb-6 fade-in">
                <h1 class="text-2xl font-bold" style="color: var(--text-primary);">Command Center</h1>
                <p class="mt-1" style="color: var(--text-secondary);">Sovereign inbox control with review-first philosophy</p>
            </div>

            <!-- Stats Row - 3 metrics - StreamHub Card Style -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <!-- Total Emails - Clickable -->
                <div id="badge-total" class="rounded-xl p-4 fade-in stagger-1 cursor-pointer transition-all" style="background: var(--surface); border: 1px solid var(--border);" onmouseover="this.style.borderColor='var(--neon-green)'; this.style.boxShadow='0 0 12px var(--neon-glow)';" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none';" title="Click to search all mail">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: var(--neon-glow);">
                            <svg class="w-5 h-5" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        </div>
                        <div>
                            <p id="stat-total" class="text-2xl font-bold font-mono" style="color: var(--text-primary);">{{ stats.total|default(0)|int }}</p>
                            <p class="text-xs" style="color: var(--text-secondary);">Total Emails</p>
                        </div>
                    </div>
                </div>
                <!-- Trashed - Session counter -->
                <div class="rounded-xl p-4 fade-in stagger-2 transition-all" style="background: var(--surface); border: 1px solid var(--border);" onmouseover="this.style.borderColor='var(--neon-green)'; this.style.boxShadow='0 0 12px var(--neon-glow)';" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none';">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: var(--neon-glow);">
                            <svg class="w-5 h-5" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </div>
                        <div>
                            <p id="stat-cleaned" class="text-2xl font-bold font-mono" style="color: var(--text-primary);">{{ total_cleaned|default(0) }}</p>
                            <p class="text-xs" style="color: var(--text-secondary);">Sent to Trash</p>
                        </div>
                    </div>
                </div>
                <!-- Estimated Size -->
                <div class="rounded-xl p-4 fade-in stagger-3 transition-all" style="background: var(--surface); border: 1px solid var(--border);" onmouseover="this.style.borderColor='var(--neon-green)'; this.style.boxShadow='0 0 12px var(--neon-glow)';" onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none';">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: var(--neon-glow);">
                            <svg class="w-5 h-5" style="color: var(--neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>
                        </div>
                        <div>
                            <p id="stat-storage" class="text-2xl font-bold font-mono" style="color: var(--text-primary);">{{ stats.storage_mb|default(0) }}MB</p>
                            <p class="text-xs" style="color: var(--text-secondary);">Est. Size</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tier Banner -->
            {% if user_tier == 'free' %}
            <div class="bg-gradient-to-r from-primary-600/10 to-purple-600/10 rounded-xl border border-primary-500/30 p-4 mb-6 fade-in">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-primary-500/20 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <div>
                            <p class="text-sm text-white"><span class="font-semibold text-primary-400">{{ remaining_deletes }}</span> free trashes left</p>
                            <p class="text-xs text-gray-500">Upgrade for unlimited.</p>
                        </div>
                    </div>
                    <a href="/pricing" class="text-sm text-primary-400 hover:text-primary-300 font-medium">Upgrade Now</a>
                </div>
            </div>
            {% endif %}

            <!-- SEARCH SECTION - Above Filters for Easy Access -->
            <div class="rounded-xl p-4" style="background: var(--surface); border: 1px solid var(--border); mb-3 fade-in">
                <h2 class="text-base font-bold text-white mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    Global Search
                </h2>
                <form id="keyword-search-form" class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="keyword-input" placeholder="Search any keyword: Jenny, unsubscribe, invoice..."
                           class="flex-1 bg-dark-850 border border-gray-700 rounded-lg px-4 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <button type="submit" id="keyword-search-btn" class="px-5 py-2.5 bg-gradient-to-r from-primary-600 to-purple-600 hover:from-primary-700 hover:to-purple-700 text-white font-semibold rounded-lg transition-all flex items-center justify-center min-w-[110px]">
                        <span id="keyword-btn-text">Search</span>
                        <svg id="keyword-btn-spinner" class="hidden animate-spin ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                    </button>
                </form>
            </div>

            <!-- Advanced Search - Compact -->
            <div class="rounded-xl p-4" style="background: var(--surface); border: 1px solid var(--border); mb-3 fade-in">
                <h2 class="text-base font-bold text-white mb-2">Advanced Search</h2>
                <form id="scan-form" class="flex flex-col sm:flex-row gap-2">
                    <select id="folder-select" class="bg-dark-850 border border-gray-700 rounded-lg px-3 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-primary-500 sm:w-40 text-sm">
                        <option value="">Folder...</option>
                        <option value="in:anywhere">All Mail</option>
                        <option value="in:inbox">Inbox</option>
                        <option value="in:sent">Sent</option>
                        <option value="in:spam">Spam</option>
                        <option value="category:promotions">Promotions</option>
                        <option value="is:unread">Unread</option>
                        <option value="older_than:1y">1+ year old</option>
                        <option value="older_than:2y">2+ years old</option>
                    </select>
                    <input type="text" id="query-input" placeholder="Gmail search syntax: from:amazon older_than:1y"
                           class="flex-1 bg-dark-850 border border-gray-700 rounded-lg px-4 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <button type="submit" id="scan-btn" class="px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center min-w-[90px]">
                        <span id="scan-btn-text">Scan</span>
                        <svg id="scan-btn-spinner" class="hidden animate-spin ml-2 h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                    </button>
                </form>
            </div>

            <!-- Smart Filters - 3x3 Grid -->
            <div class="mb-3 fade-in">
                <h2 class="text-base font-semibold text-white mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                    Smart Filters
                    <span class="ml-2 text-xs text-gray-500 font-normal italic">(individual email count, not threads)</span>
                </h2>
                <div class="filter-grid">
                    <!-- Inbox (Orange) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-1" data-query="in:inbox" id="inbox-filter-v4">
                        <div class="filter-left">
                            <div class="filter-icon inbox-icon-orange rounded-lg flex items-center justify-center" style="background: rgba(255, 152, 0, 0.2) !important;">
                                <svg class="w-full h-full p-1" style="color: #ff9800 !important; stroke: #ff9800 !important;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                            </div>
                            <span class="filter-name">Inbox</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="inbox">-</span>
                            <span class="filter-thread-compare" data-threads="inbox"></span>
                        </div>
                    </div>
                    <!-- Starred (Yellow) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-2" data-query="is:starred">
                        <div class="filter-left">
                            <div class="filter-icon bg-yellow-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            </div>
                            <span class="filter-name">Starred</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="starred">-</span>
                            <span class="filter-thread-compare" data-threads="starred"></span>
                        </div>
                    </div>
                    <!-- Unread (Cyan) - HIGH VALUE EASY WIN -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-3" data-query="is:unread">
                        <div class="filter-left">
                            <div class="filter-icon bg-cyan-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/><circle cx="18" cy="6" r="3" fill="#06b6d4"/></svg>
                            </div>
                            <span class="filter-name">Unread</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="unread">-</span>
                            <span class="filter-thread-compare" data-threads="unread"></span>
                        </div>
                    </div>
                    <!-- Sent (Blue) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-4" data-query="in:sent">
                        <div class="filter-left">
                            <div class="filter-icon bg-blue-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                            </div>
                            <span class="filter-name">Sent</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="sent">-</span>
                            <span class="filter-thread-compare" data-threads="sent"></span>
                        </div>
                    </div>
                    <!-- Drafts (Gray) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-5" data-query="in:drafts">
                        <div class="filter-left">
                            <div class="filter-icon bg-gray-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </div>
                            <span class="filter-name">Drafts</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="drafts">-</span>
                            <span class="filter-thread-compare" data-threads="drafts"></span>
                        </div>
                    </div>
                    <!-- Purchases (Green) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-6" data-query="category:purchases">
                        <div class="filter-left">
                            <div class="filter-icon bg-green-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
                            </div>
                            <span class="filter-name">Purchases</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="purchases">-</span>
                            <span class="filter-thread-compare" data-threads="purchases"></span>
                        </div>
                    </div>
                    <!-- Updates (Teal) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-1" data-query="category:updates">
                        <div class="filter-left">
                            <div class="filter-icon bg-teal-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                            </div>
                            <span class="filter-name">Updates</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="updates">-</span>
                            <span class="filter-thread-compare" data-threads="updates"></span>
                        </div>
                    </div>
                    <!-- Promotions (Pink) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-2" data-query="category:promotions">
                        <div class="filter-left">
                            <div class="filter-icon bg-pink-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                            </div>
                            <span class="filter-name">Promotions</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="promotions">-</span>
                            <span class="filter-thread-compare" data-threads="promotions"></span>
                        </div>
                    </div>
                    <!-- Spam (Red) -->
                    <div class="filter-card filter-compact bg-dark-900 rounded-xl border border-gray-800 fade-in stagger-3" data-query="in:spam">
                        <div class="filter-left">
                            <div class="filter-icon bg-red-500/10 rounded-lg flex items-center justify-center">
                                <svg class="w-full h-full p-1 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            </div>
                            <span class="filter-name">Spam</span>
                        </div>
                        <div class="filter-right">
                            <span class="filter-count" data-count="spam">-</span>
                            <span class="filter-thread-compare" data-threads="spam"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== THE SAFETY VAULT - PROMINENT GREEN UI ====== -->
            <div id="safety-vault-container" class="vault-container bg-gradient-to-r from-green-900/40 to-emerald-900/40 rounded-2xl border-2 border-green-500/60 p-5 mb-4 fade-in shadow-xl shadow-green-900/30 relative">
                <!-- Glow effect -->
                <div class="absolute inset-0 rounded-2xl bg-green-500/5 pointer-events-none"></div>

                <div class="relative flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-3">
                    <div class="flex items-center space-x-4">
                        <!-- Large Shield Icon -->
                        <div class="w-14 h-14 bg-gradient-to-br from-green-500/30 to-emerald-600/30 rounded-2xl flex items-center justify-center border border-green-400/40 glow-pulse">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-green-400 tracking-tight flex items-center">
                                <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                                THE VAULT
                            </h2>
                            <p class="text-sm text-green-300/90 font-medium">100% Protected Sanctuary - Safe from ALL trash actions</p>
                        </div>
                        <!-- How it Works Tooltip -->
                        <div class="relative group ml-2 hidden sm:block">
                            <svg class="w-5 h-5 text-gray-400 cursor-help hover:text-green-400 transition-colors" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>
                            <div class="absolute left-0 bottom-full mb-2 w-80 p-4 bg-gray-800 rounded-xl border border-green-500/30 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                                <p class="text-sm text-white font-bold mb-2">How the Vault Works</p>
                                <p class="text-sm text-gray-300 leading-relaxed mb-2">Click the green checkbox on any email to instantly lock it in the Vault. Vaulted items are <strong class="text-green-400">completely segregated</strong> from Inbox and Trash views.</p>
                                <p class="text-xs text-green-400 font-medium">Data persists across browser sessions!</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Open Vault Sanctuary Button -->
                        <button id="open-vault-sanctuary" class="px-4 py-2 bg-green-600/30 hover:bg-green-600/50 text-green-300 hover:text-white text-sm font-semibold rounded-lg border border-green-500/40 hover:border-green-400 transition-all flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            <span>View Sanctuary</span>
                        </button>
                        <!-- Vault Count Badge -->
                        <span id="vault-count" class="text-lg font-black text-green-400 bg-green-500/30 px-5 py-2.5 rounded-full border-2 border-green-500/50 shadow-lg shadow-green-900/30 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            <span id="vault-count-num">0</span> protected
                        </span>
                    </div>
                </div>

                <!-- Vault Items Preview -->
                <div id="untouchable-list" class="max-h-52 overflow-y-auto custom-scrollbar space-y-2 bg-dark-900/60 rounded-xl p-4 border border-green-500/30">
                    <p class="text-sm text-gray-500 italic py-4 text-center flex flex-col items-center">
                        <svg class="w-8 h-8 text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        No items in vault yet. Click the green checkbox on any email to protect it.
                    </p>
                </div>
            </div>

            <!-- SAFETY SWITCHES - Always Protect -->
            <div class="rounded-xl p-4" style="background: var(--surface); border: 1px solid var(--border); mb-3 fade-in">
                <h2 class="text-base font-bold text-white mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    Always Protect
                </h2>
                <p class="text-xs text-gray-400 mb-3">Auto-shield emails matching these. Excluded from all "Move to Trash" actions:</p>

                <!-- Smart Safety Toggles - Compact Horizontal -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <label class="flex items-center space-x-2 px-3 py-2 bg-dark-850 rounded-lg cursor-pointer hover:bg-green-900/30 transition-colors border border-gray-700 hover:border-green-500/50">
                        <input type="checkbox" id="protect-pictures" class="safety-checkbox w-4 h-4 accent-green-500" data-keyword="has:attachment filename:(jpg OR jpeg OR png OR gif OR heic)">
                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        <span class="text-sm font-medium text-white">Pictures</span>
                    </label>
                    <label class="flex items-center space-x-2 px-3 py-2 bg-dark-850 rounded-lg cursor-pointer hover:bg-green-900/30 transition-colors border border-gray-700 hover:border-green-500/50">
                        <input type="checkbox" id="protect-attachments" class="safety-checkbox w-4 h-4 accent-green-500" data-keyword="has:attachment">
                        <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                        <span class="text-sm font-medium text-white">Attachments</span>
                    </label>
                    <label class="flex items-center space-x-2 px-3 py-2 bg-dark-850 rounded-lg cursor-pointer hover:bg-green-900/30 transition-colors border border-gray-700 hover:border-green-500/50">
                        <input type="checkbox" id="protect-starred" class="safety-checkbox w-4 h-4 accent-green-500" data-keyword="is:starred">
                        <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        <span class="text-sm font-medium text-white">Starred</span>
                    </label>
                    <label class="flex items-center space-x-2 px-3 py-2 bg-dark-850 rounded-lg cursor-pointer hover:bg-green-900/30 transition-colors border border-gray-700 hover:border-green-500/50">
                        <input type="checkbox" id="protect-large" class="safety-checkbox w-4 h-4 accent-green-500" data-keyword="larger:5M">
                        <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <span class="text-sm font-medium text-white">Large Files (5MB+)</span>
                    </label>
                    <label class="flex items-center space-x-2 px-3 py-2 bg-dark-850 rounded-lg cursor-pointer hover:bg-green-900/30 transition-colors border border-gray-700 hover:border-green-500/50">
                        <input type="checkbox" id="protect-important" class="safety-checkbox w-4 h-4 accent-green-500" data-keyword="is:important">
                        <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                        <span class="text-sm font-medium text-white">Important</span>
                    </label>
                    <label class="flex items-center space-x-2 px-3 py-2 bg-dark-850 rounded-lg cursor-pointer hover:bg-green-900/30 transition-colors border border-gray-700 hover:border-green-500/50">
                        <input type="checkbox" id="protect-purchases" class="safety-checkbox w-4 h-4 accent-green-500" data-keyword="category:purchases">
                        <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        <span class="text-sm font-medium text-white">Purchases</span>
                    </label>
                    <label class="flex items-center space-x-2 px-3 py-2 bg-dark-850 rounded-lg cursor-pointer hover:bg-green-900/30 transition-colors border border-gray-700 hover:border-green-500/50">
                        <input type="checkbox" id="protect-social" class="safety-checkbox w-4 h-4 accent-green-500" data-keyword="category:social">
                        <svg class="w-4 h-4 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        <span class="text-sm font-medium text-white">Social</span>
                    </label>
                </div>

                <!-- Custom Keyword Input -->
                <div class="flex gap-2 mb-3">
                    <input type="text" id="custom-protect-keyword" placeholder="Add custom keyword..."
                           class="flex-1 bg-dark-850 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button id="add-protect-keyword" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition-colors">
                        + Add
                    </button>
                </div>
                <div id="protected-keywords-list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- 30-DAY WARNING + RESCUE CTA -->
            <div class="rounded-xl border-2 border-amber-500/50 p-4 mb-4 fade-in" style="background: linear-gradient(135deg, rgba(120,53,15,0.4) 0%, rgba(30,20,5,0.6) 100%);">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex items-start space-x-3 flex-1">
                        <svg class="w-6 h-6 text-amber-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                        <div>
                            <p class="text-base font-bold text-amber-300 mb-1">Your emails are never permanently deleted by us</p>
                            <p class="text-sm text-amber-100/80 leading-relaxed">MailRemover only moves emails to your Gmail Trash — we never permanently delete anything. Gmail automatically removes Trash items after 30 days per Google's retention policy. Use <strong class="text-white">Rescue from Trash</strong> to save a local copy before that window closes.</p>
                        </div>
                    </div>
                    <button id="open-rescue-modal" class="flex-shrink-0 flex items-center space-x-2 px-4 py-2.5 rounded-xl font-bold text-sm text-black transition-all" style="background: #39FF14; box-shadow: 0 0 12px rgba(57,255,20,0.5);" onmouseover="this.style.boxShadow='0 0 20px rgba(57,255,20,0.8)'" onmouseout="this.style.boxShadow='0 0 12px rgba(57,255,20,0.5)'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                        <span>Rescue from Trash</span>
                    </button>
                </div>
            </div>

            <!-- ====== SAFETY VAULT - PURGE TEMPORARY DATA ====== -->
            <div class="bg-gradient-to-r from-slate-800/50 to-slate-700/30 rounded-xl border border-slate-600/50 p-5 mb-4 fade-in">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 bg-slate-500/20 rounded-xl flex items-center justify-center flex-shrink-0">
                            <svg class="w-7 h-7 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                        </div>
                        <div>
                            <p class="text-lg font-bold text-slate-200">Safety Vault</p>
                            <p class="text-sm text-slate-400 leading-relaxed">Temporary storage for your scan results and selections.<br>This data exists only in your browser — never on our servers.</p>
                        </div>
                    </div>
                    <button id="purge-vault-btn" class="tooltip w-full sm:w-auto px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white text-sm font-semibold rounded-xl transition-all flex items-center justify-center space-x-2 border border-slate-500/50">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        <span>Purge Temporary Vault</span>
                        <span class="tooltip-text">Clears AI-analyzed snippets and scan metadata from your browser. Your actual emails in Gmail are never touched.</span>
                    </button>
                </div>
            </div>

            <!-- ====== SECURE SIGN OUT ====== -->
            <div class="bg-gradient-to-r from-emerald-900/20 to-teal-900/20 rounded-xl border border-emerald-500/30 p-5 mb-6 fade-in">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center flex-shrink-0">
                            <svg class="w-7 h-7 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                        </div>
                        <div>
                            <p class="text-lg font-bold text-emerald-300">Secure Sign Out</p>
                            <p class="text-sm text-emerald-400/80 leading-relaxed">Clears all temporary browser data and signs you out safely.</p>
                        </div>
                    </div>
                    <button id="wipe-session-btn" class="tooltip w-full sm:w-auto px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold rounded-xl transition-all flex items-center justify-center space-x-2 border border-emerald-500/50">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        <span>Secure Sign Out</span>
                        <span class="tooltip-text">Your Gmail data is safe. This only clears the temporary browser cache.</span>
                    </button>
                </div>
            </div>

            <!-- Suggestion Box -->
            <div class="rounded-xl p-6" style="background: var(--surface); border: 1px solid var(--border); mb-6 fade-in">
                <h2 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707"/></svg>
                    Have feedback?
                </h2>
                <p class="text-sm text-gray-400 mb-3">Have an email account you wish we supported on this site? Tell us about it!</p>
                <form id="suggestion-form">
                    <textarea id="suggestion-text" rows="2" placeholder="e.g., 'Please add Yahoo Mail support!' or any other feedback..."
                              class="w-full bg-dark-850 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                    <div class="flex items-center justify-between mt-3">
                        <p id="suggestion-status" class="text-sm text-gray-500"></p>
                        <button type="submit" id="suggestion-btn" class="px-5 py-2 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-lg transition-colors">Submit</button>
                    </div>
                </form>
            </div>

            <div id="alert-container" class="mb-6"></div>

            <!-- ====== SECURITY PROMISE ====== -->
            <div class="bg-gradient-to-r from-blue-900/20 to-indigo-900/20 rounded-xl border border-blue-500/30 p-5 mb-4 fade-in">
                <div class="flex items-start space-x-4">
                    <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    </div>
                    <div>
                        <p class="text-base font-bold text-blue-300 mb-1">Our Security Promise</p>
                        <p class="text-sm text-blue-200/80 leading-relaxed"><strong class="text-white">We never delete your emails.</strong> We only simplify them. When you use MailRemover, emails are moved to Gmail's Trash — where they remain for 30 days and can be recovered anytime. Your original emails are always safe in your Gmail account.</p>
                    </div>
                </div>
            </div>

            <!-- ====== GOOGLE API DISCLOSURE & PRIVACY FOOTER ====== -->
            <div class="rounded-xl" style="background: var(--panel); border: 1px solid var(--border); p-5 mb-6 fade-in">
                <div class="space-y-4 text-sm text-gray-400 leading-relaxed">
                    <div>
                        <p class="text-xs font-semibold text-gray-300 uppercase tracking-wide mb-2">Google API Disclosure</p>
                        <p class="text-xs">MailRemover's use and transfer to any other app of information received from Google APIs will adhere to the <a href="https://developers.google.com/terms/api-services-user-data-policy" target="_blank" rel="noopener" class="text-primary-400 hover:text-primary-300 underline">Google API Services User Data Policy</a>, including the Limited Use requirements.</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-300 uppercase tracking-wide mb-2">Privacy Guarantee</p>
                        <p class="text-xs">We do not save your email content or your full credit card information. We only store your email address for account access. We never share or sell your information to anyone.</p>
                    </div>
                    <div class="flex items-center justify-center space-x-4 pt-2 border-t border-gray-800">
                        <a href="/privacy" class="text-xs text-gray-500 hover:text-primary-400 transition-colors">Privacy Policy</a>
                        <span class="text-gray-700">|</span>
                        <a href="/tos" class="text-xs text-gray-500 hover:text-primary-400 transition-colors">Terms of Service</a>
                        <span class="text-gray-700">|</span>
                        <a href="mailto:support@mailremover.com" class="text-xs text-gray-500 hover:text-primary-400 transition-colors">Contact</a>
                    </div>
                    <!-- Version Display -->
                    <div class="text-center pt-3 mt-3 border-t border-gray-800">
                        <span id="app-version" class="text-[10px] text-gray-600">v2.1.0</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FOCUS SEARCH OVERLAY -->
    <div id="search-overlay" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/95"></div>
        <div class="absolute inset-0 flex flex-col pop-in">
            <!-- Overlay Header -->
            <div id="overlay-header" class="bg-dark-900 border-b border-gray-800 px-4 sm:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button id="overlay-close" class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                    <div>
                        <h2 id="results-header" class="text-lg font-semibold text-white">Search Results</h2>
                        <p class="text-sm text-gray-400">
                            <span id="overlay-total-count" class="text-primary-400 font-semibold">0</span> emails from
                            <span id="overlay-sender-count" class="text-primary-400 font-semibold">0</span> senders
                            <span id="safelist-count" class="text-blue-400 ml-2 hidden flex items-center"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg><span id="safelist-num">0</span> safe</span>
                        </p>
                        <!-- Batch limit status note -->
                        <p id="batch-status-note" class="text-xs text-amber-400/80 mt-1 hidden">
                            <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                            <span id="batch-status-text">Showing first 600 results. Move these to Trash to reveal more.</span>
                        </p>
                        <!-- DATA TRUTH TRANSPARENCY MODULE -->
                        <div id="data-truth-module" class="mt-2 hidden">
                            <div class="flex items-center gap-4 text-xs">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">Gmail shows:</span>
                                    <span id="gmail-thread-count" class="text-gray-400 font-medium">0</span>
                                    <span class="text-gray-600">conversations</span>
                                </div>
                                <span class="text-gray-700">|</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">We found:</span>
                                    <span id="our-message-count" class="text-primary-400 font-semibold">0</span>
                                    <span class="text-gray-400">individual messages</span>
                                </div>
                                <span id="data-truth-ratio" class="text-green-400 font-medium hidden">(+0% hidden data)</span>
                            </div>
                            <p class="text-[10px] text-gray-600 italic mt-1">We count every byte so nothing stays hidden.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== MINIMAL HEADER BAR ====== -->
            <div id="mode-control-bar" class="mode-control-bar bg-dark-900 border-b border-gray-700 px-4 py-3">
                <!-- LEFT: Plain Master Checkboxes -->
                <div class="control-left flex items-center gap-5">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="master-trash-cb" class="plain-checkbox trash-check">
                        <span class="text-sm text-gray-400">Trash</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="master-safe-cb" class="plain-checkbox safe-check">
                        <span class="text-sm text-gray-400">Safe</span>
                    </label>
                    <span class="text-gray-700 hidden sm:inline">|</span>
                    <span id="overlay-selected-info" class="text-gray-400 text-sm">0 selected</span>
                </div>

                <!-- RIGHT: Toggle + Execute -->
                <div class="control-right flex items-center gap-3">
                    <label for="live-mode-toggle" class="mode-toggle-container">
                        <span class="mode-toggle-label" id="mode-label-practice">PRACTICE</span>
                        <input type="checkbox" id="live-mode-toggle" class="toggle-checkbox">
                        <div class="toggle-slider"></div>
                        <span class="mode-toggle-label inactive" id="mode-label-live">LIVE</span>
                    </label>
                    <button id="overlay-trash-btn" disabled class="execute-btn bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm font-medium">
                        <span id="overlay-trash-btn-text">Run Simulation</span>
                    </button>
                </div>
            </div>

            <!-- Mobile Execute (sticky bottom) -->
            <div class="sm:hidden fixed bottom-0 left-0 right-0 bg-dark-900 border-t border-gray-800 p-4 z-10">
                <div class="flex items-center justify-between gap-3">
                    <span id="overlay-selected-mobile" class="text-sm text-gray-400 font-medium">0 selected</span>
                    <button id="overlay-trash-btn-mobile" disabled
                            class="flex-1 max-w-[200px] px-4 py-3 bg-gray-600 hover:bg-gray-700 disabled:bg-gray-700 disabled:text-gray-500 text-white font-bold rounded-xl text-base">
                        Simulate
                    </button>
                </div>
            </div>

            <div id="overlay-alert" class="px-4 sm:px-6 py-2"></div>

            <!-- Sender List with Save Column -->
            <div id="overlay-sender-list" class="flex-1 overflow-y-auto custom-scrollbar bg-dark-900/95 pb-20 sm:pb-0"></div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-[60] hidden">
        <div id="modal-backdrop" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="absolute inset-4 sm:inset-8 flex items-center justify-center">
            <div class="rounded-2xl" style="background: var(--surface); border: 1px solid var(--border); w-full max-w-4xl max-h-full flex flex-col shadow-2xl">
                <div class="p-5 border-b border-gray-800 flex items-start justify-between">
                    <div class="flex-1 min-w-0 pr-4">
                        <h3 id="modal-subject" class="text-lg font-semibold text-white truncate">Loading...</h3>
                        <div class="mt-2 flex flex-wrap gap-x-4 text-sm text-gray-400">
                            <span id="modal-from">...</span>
                            <span id="modal-date">...</span>
                        </div>
                    </div>
                    <button id="modal-close" class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>
                <div id="modal-body" class="flex-1 overflow-hidden">
                    <div id="modal-loading" class="flex items-center justify-center py-12"><svg class="animate-spin h-8 w-8 text-primary-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg></div>
                    <div id="modal-content" class="hidden h-full"><iframe id="email-iframe" class="w-full h-full border-0 bg-white" sandbox="allow-same-origin" style="min-height:400px;"></iframe></div>
                    <div id="modal-text-content" class="hidden p-5 overflow-auto max-h-[60vh]"><pre id="modal-text" class="whitespace-pre-wrap text-sm text-gray-300 font-mono"></pre></div>
                    <div id="modal-error" class="hidden text-center py-12"><p class="text-red-400">Failed to load</p></div>
                </div>
                <div class="p-5 border-t border-gray-800 flex items-center justify-between">
                    <button id="modal-close-btn" class="px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg">Close</button>
                    <button id="modal-trash-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg flex items-center">Trash</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deletion Progress Overlay -->
    <div id="deletion-overlay" class="fixed inset-0 z-[70] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="rounded-2xl" style="background: var(--surface); border: 1px solid var(--border); p-8 max-w-sm w-full mx-4 text-center">
            <div class="relative w-20 h-20 mx-auto mb-6">
                <svg class="animate-spin w-20 h-20 text-primary-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
            </div>
            <h3 id="deletion-title" class="text-xl font-bold text-white mb-2">Processing...</h3>
            <p id="deletion-message" class="text-gray-400 mb-4">Please wait</p>
            <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                <div id="deletion-progress" class="bg-gradient-to-r from-primary-500 to-purple-500 h-2 rounded-full transition-all duration-200" style="width:0%"></div>
            </div>
            <p id="deletion-count" class="text-sm text-gray-500 mt-2">0 processed</p>
        </div>
    </div>

    <!-- GAS GAUGE OVERLAY -->
    <div id="gauge-overlay" class="gauge-overlay hidden">
        <div class="gauge-container">
            <svg class="gauge-svg" viewBox="0 0 280 180">
                <!-- Background arc -->
                <path class="gauge-bg" d="M 30 150 A 110 110 0 0 1 250 150" />
                <!-- Colored fill arc (will be animated) -->
                <path id="gauge-arc" class="gauge-fill" d="M 30 150 A 110 110 0 0 1 250 150"
                      stroke="#ef4444"
                      stroke-dasharray="345"
                      stroke-dashoffset="345" />
                <!-- Tick marks -->
                <g class="gauge-ticks">
                    <line x1="45" y1="135" x2="55" y2="125" />
                    <line x1="75" y1="75" x2="88" y2="82" />
                    <line x1="140" y1="45" x2="140" y2="60" />
                    <line x1="205" y1="75" x2="192" y2="82" />
                    <line x1="235" y1="135" x2="225" y2="125" />
                </g>
                <!-- Speed markers -->
                <text class="gauge-marker" x="35" y="165">0</text>
                <text class="gauge-marker" x="70" y="70">25</text>
                <text class="gauge-marker" x="132" y="40">50</text>
                <text class="gauge-marker" x="198" y="70">75</text>
                <text class="gauge-marker" x="235" y="165">100</text>
                <!-- Needle -->
                <polygon id="gauge-needle" class="gauge-needle" points="140,55 135,145 140,150 145,145" />
                <!-- Center cap -->
                <circle class="gauge-center" cx="140" cy="145" r="12" />
            </svg>
            <!-- Percentage display -->
            <div class="absolute inset-0 flex items-end justify-center pb-2">
                <span id="gauge-percent" class="text-4xl font-bold text-white">0%</span>
            </div>
        </div>
        <div class="gauge-status">
            <p id="gauge-status-text" class="gauge-status-text text-pulse">Scanning your inbox...</p>
            <p id="gauge-status-sub" class="gauge-status-sub">Parallel processing active</p>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/80" onclick="closeUpgradeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="rounded-2xl" style="background: var(--surface); border: 1px solid var(--border); p-8 max-w-md w-full text-center">
                <h3 class="text-xl font-bold text-white mb-2">Upgrade to Continue</h3>
                <p class="text-gray-400 mb-6" id="upgrade-modal-message">You've used all free trashes. Upgrade for unlimited.</p>
                <a href="/pricing" class="block w-full py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl">View Plans</a>
                <button onclick="closeUpgradeModal()" class="block w-full py-3 mt-3 text-gray-400 hover:text-white">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Yahoo App Password Connection Modal -->
    <div id="yahoo-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/85 backdrop-blur-sm" onclick="closeYahooModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
            <div class="rounded-2xl" style="background: var(--surface); border: 1px solid var(--border); max-w-lg w-full shadow-2xl my-8">
                <!-- Header with calming gradient accent -->
                <div class="relative p-6 border-b border-gray-800">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-purple-500 via-violet-500 to-purple-600 rounded-t-2xl"></div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-400" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M10.816 8.768l-4.2 6.632L2.4 8.768H0l5.6 8.832v6.4h3.2v-6.4L14.4 8.768h-3.584zm5.984 0L24 8.768h-3.6l-4.8 7.6 1.6 2.4 2.4-3.8 4.8 7.832h3.6l-7.2-11.232z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-white">Connect Yahoo Mail</h3>
                                <p class="text-sm text-gray-400">Just a few peaceful steps</p>
                            </div>
                        </div>
                        <button onclick="closeYahooModal()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Body with step-by-step guide -->
                <div class="p-6 space-y-6">
                    <!-- Calming introduction -->
                    <div class="bg-purple-500/5 border border-purple-500/20 rounded-xl p-4">
                        <p class="text-gray-300 text-sm leading-relaxed">
                            Let's set up your Yahoo connection. Yahoo requires an <strong class="text-purple-300">App Password</strong> for secure access.
                            This keeps your main password safe while letting us help manage your inbox.
                        </p>
                    </div>

                    <!-- Step-by-step visual guide -->
                    <div class="space-y-4">
                        <h4 class="text-sm font-medium text-gray-400 uppercase tracking-wide">How to generate your App Password</h4>

                        <!-- Step 1 -->
                        <div class="flex gap-4 items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500/20 border border-purple-500/40 flex items-center justify-center">
                                <span class="text-purple-400 font-semibold text-sm">1</span>
                            </div>
                            <div class="flex-1 pt-1">
                                <p class="text-gray-300 text-sm">Visit Yahoo's security settings</p>
                                <a href="https://login.yahoo.com/account/security" target="_blank" rel="noopener noreferrer"
                                   class="inline-flex items-center gap-1.5 mt-2 px-3 py-1.5 bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/30 rounded-lg text-purple-300 text-xs font-medium transition-colors">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                    Open Yahoo Security
                                </a>
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div class="flex gap-4 items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500/20 border border-purple-500/40 flex items-center justify-center">
                                <span class="text-purple-400 font-semibold text-sm">2</span>
                            </div>
                            <div class="flex-1 pt-1">
                                <p class="text-gray-300 text-sm">Click <strong class="text-white">"Generate app password"</strong></p>
                                <p class="text-gray-500 text-xs mt-1">You may need to enable 2-step verification first</p>
                            </div>
                        </div>

                        <!-- Step 3 -->
                        <div class="flex gap-4 items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500/20 border border-purple-500/40 flex items-center justify-center">
                                <span class="text-purple-400 font-semibold text-sm">3</span>
                            </div>
                            <div class="flex-1 pt-1">
                                <p class="text-gray-300 text-sm">Select <strong class="text-white">"Other App"</strong> and name it <strong class="text-white">"MailRemover"</strong></p>
                            </div>
                        </div>

                        <!-- Step 4 -->
                        <div class="flex gap-4 items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500/20 border border-purple-500/40 flex items-center justify-center">
                                <span class="text-purple-400 font-semibold text-sm">4</span>
                            </div>
                            <div class="flex-1 pt-1">
                                <p class="text-gray-300 text-sm">Copy the generated password and paste it below</p>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Form -->
                    <div class="space-y-4 pt-2">
                        <div>
                            <label for="yahoo-email" class="block text-sm font-medium text-gray-300 mb-2">Yahoo Email Address</label>
                            <input type="email" id="yahoo-email" placeholder="your.email@yahoo.com"
                                   class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500/50 focus:ring-1 focus:ring-purple-500/30 transition-colors">
                        </div>
                        <div>
                            <label for="yahoo-app-password" class="block text-sm font-medium text-gray-300 mb-2">App Password</label>
                            <input type="password" id="yahoo-app-password" placeholder="xxxx xxxx xxxx xxxx"
                                   class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500/50 focus:ring-1 focus:ring-purple-500/30 transition-colors font-mono tracking-wider">
                        </div>
                    </div>

                    <!-- Security reassurance -->
                    <div class="flex items-start gap-3 p-3 bg-green-500/5 border border-green-500/20 rounded-xl">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-green-300 text-sm font-medium">Your credentials are secure</p>
                            <p class="text-gray-400 text-xs mt-0.5">Your App Password is encrypted and stored safely. We never have access to your main Yahoo password.</p>
                        </div>
                    </div>
                </div>

                <!-- Footer with actions -->
                <div class="p-6 border-t border-gray-800 flex items-center justify-between gap-4">
                    <button onclick="closeYahooModal()" class="px-4 py-2.5 text-gray-400 hover:text-white hover:bg-gray-800 rounded-xl transition-colors">
                        Cancel
                    </button>
                    <div class="flex items-center gap-3">
                        <button id="yahoo-test-btn" onclick="testYahooConnection()"
                                class="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 font-medium rounded-xl transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Test Connection
                        </button>
                        <button id="yahoo-connect-btn" onclick="connectYahooAccount()"
                                class="px-5 py-2.5 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-xl transition-colors">
                            Connect Yahoo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // STATE
        // =====================================================================
        let senderData = {};
        let senderEmails = [];
        let selectedSenders = new Set();
        let currentQuery = '';
        let practiceMode = true;
        const MAX_IDS = 1000;
        const userTier = '{{ user_tier }}';

        // =====================================================================
        // PROVIDER SESSION MANAGEMENT
        // =====================================================================
        const primaryProvider = '{{ primary_provider|default("gmail") }}';
        const connectedProviders = {{ connected_providers|tojson|default('[]') }};

        /**
         * Switch the active/primary provider
         * @param {string} provider - Provider name ('gmail', 'yahoo', 'outlook')
         */
        async function switchProvider(provider) {
            // Check if provider is connected
            const isConnected = connectedProviders.some(p => p.name === provider);
            if (!isConnected) {
                console.log(`[PROVIDER] ${provider} is not connected`);
                // If Yahoo, open modal to connect
                if (provider === 'yahoo') {
                    openYahooModal();
                }
                return;
            }

            // Already the primary provider
            if (provider === primaryProvider) {
                console.log(`[PROVIDER] ${provider} is already the primary provider`);
                return;
            }

            try {
                const response = await fetch('/api/switch-provider', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider })
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    console.log(`[PROVIDER] Switched to ${provider}`);
                    // Reload page to refresh all stats and UI for new provider
                    window.location.href = `/dashboard?provider=${provider}`;
                } else {
                    console.error(`[PROVIDER] Failed to switch:`, data.error);
                    showAlert(`Failed to switch provider: ${data.error}`, 'error');
                }
            } catch (e) {
                console.error(`[PROVIDER] Error switching provider:`, e);
                showAlert('Error switching provider. Please try again.', 'error');
            }
        }

        /**
         * Get stats placeholder for providers other than Gmail
         * (Until backend support is added)
         */
        function getProviderStats(provider) {
            // For Yahoo, show placeholder stats until backend is implemented
            if (provider === 'yahoo') {
                return {
                    total: 0,
                    unread: 0,
                    storage_mb: 0,
                    storage_percent: 0,
                    placeholder: true,
                    message: 'Yahoo Mail integration coming soon. Stats will appear once connected.'
                };
            }
            // Default Gmail stats are loaded from the template
            return null;
        }

        /**
         * Check URL params for provider switch request
         */
        function checkProviderUrlParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestedProvider = urlParams.get('provider');
            if (requestedProvider && requestedProvider !== primaryProvider) {
                // Already handled server-side, but log for debugging
                console.log(`[PROVIDER] URL requested provider: ${requestedProvider}`);
            }
        }

        // =====================================================================
        // VAULT SYSTEM - PERSISTENT STORAGE WITH KEYWORD FIREWALL
        // =====================================================================

        // Migrate from old sessionStorage to new localStorage vault
        function migrateVaultData() {
            // Check for old sessionStorage data
            const oldSafelist = sessionStorage.getItem('mailremover_safelist');
            if (oldSafelist) {
                try {
                    const oldIds = JSON.parse(oldSafelist);
                    const existingVault = JSON.parse(localStorage.getItem('mailremover_vault') || '{"ids":[],"metadata":{}}');
                    // Merge old IDs into new vault
                    oldIds.forEach(id => {
                        if (!existingVault.ids.includes(id)) {
                            existingVault.ids.push(id);
                        }
                    });
                    localStorage.setItem('mailremover_vault', JSON.stringify(existingVault));
                    // Clear old sessionStorage
                    sessionStorage.removeItem('mailremover_safelist');
                    console.log('[VAULT] Migrated', oldIds.length, 'items from sessionStorage to localStorage');
                } catch (e) {
                    console.error('[VAULT] Migration error:', e);
                }
            }
        }

        // Run migration on load
        migrateVaultData();

        // Load vault from localStorage (persistent across sessions)
        function loadVaultFromStorage() {
            try {
                const vaultData = JSON.parse(localStorage.getItem('mailremover_vault') || '{"ids":[],"metadata":{}}');
                return {
                    ids: new Set(vaultData.ids || []),
                    metadata: vaultData.metadata || {}
                };
            } catch (e) {
                console.error('[VAULT] Load error:', e);
                return { ids: new Set(), metadata: {} };
            }
        }

        // Initialize vault from persistent storage
        const vaultStorage = loadVaultFromStorage();
        const safelist = vaultStorage.ids;
        const vaultMetadata = vaultStorage.metadata;

        // Protected keywords - also persistent
        function loadProtectedKeywords() {
            try {
                return JSON.parse(localStorage.getItem('mailremover_keywords') || '[]');
            } catch (e) {
                return [];
            }
        }
        let protectedKeywordsList = loadProtectedKeywords();

        function saveSafelist() {
            // Save to localStorage for persistence
            const vaultData = {
                ids: Array.from(safelist),
                metadata: vaultMetadata,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('mailremover_vault', JSON.stringify(vaultData));
            updateSafelistUI();
            updateVaultDisplay();
            updateFloatingVaultBadge();
        }

        // Add item to vault with metadata
        function addToVault(msgId, metadata = {}) {
            if (safelist.has(msgId)) return false;
            safelist.add(msgId);
            vaultMetadata[msgId] = {
                ...metadata,
                addedAt: new Date().toISOString()
            };
            saveSafelist();
            // Trigger vault protection animation
            if (typeof triggerVaultAnimation === 'function') {
                triggerVaultAnimation([msgId]);
            }
            return true;
        }

        // Remove item from vault
        function removeFromVault(msgId) {
            if (!safelist.has(msgId)) return false;
            safelist.delete(msgId);
            delete vaultMetadata[msgId];
            saveSafelist();
            return true;
        }

        // Check if email matches protected keywords
        function matchesProtectedKeyword(subject, sender) {
            if (!protectedKeywordsList || protectedKeywordsList.length === 0) return null;
            const searchText = `${subject || ''} ${sender || ''}`.toLowerCase();
            for (const kw of protectedKeywordsList) {
                if (searchText.includes(kw.toLowerCase())) {
                    return kw;
                }
            }
            return null;
        }

        // Show keyword warning before trashing
        function showKeywordWarning(keyword, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-dark-900 rounded-2xl border-2 border-amber-500/50 max-w-md w-full mx-4 shadow-2xl overflow-hidden pop-in">
                    <div class="p-6 bg-amber-900/20 border-b border-amber-500/30">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-amber-400">Protected Keyword Alert!</h3>
                                <p class="text-sm text-amber-200/80">This email matches a protected keyword</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-300 mb-4">This email contains the protected keyword: <span class="font-bold text-amber-400">"${escapeHtml(keyword)}"</span></p>
                        <p class="text-sm text-gray-400 mb-4">Consider adding it to the Vault instead of trashing.</p>
                        <div class="flex justify-end space-x-3">
                            <button id="kw-cancel" class="px-4 py-2 text-gray-400 hover:text-white transition-colors">Cancel</button>
                            <button id="kw-vault" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white font-semibold rounded-lg transition-colors">Add to Vault</button>
                            <button id="kw-proceed" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition-colors">Trash Anyway</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('kw-cancel').addEventListener('click', () => modal.remove());
            document.getElementById('kw-vault').addEventListener('click', () => {
                modal.remove();
                callback('vault');
            });
            document.getElementById('kw-proceed').addEventListener('click', () => {
                modal.remove();
                callback('proceed');
            });
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        function updateSafelistUI() {
            const count = safelist.size;
            const el = document.getElementById('safelist-count');
            const numEl = document.getElementById('safelist-num');
            if (el && numEl) {
                if (count > 0) {
                    el.classList.remove('hidden');
                    numEl.textContent = count;
                } else {
                    el.classList.add('hidden');
                }
            }
        }

        // Update floating vault badge
        function updateFloatingVaultBadge() {
            const badge = document.getElementById('floating-vault-badge');
            const countEl = document.getElementById('floating-vault-count');
            if (badge && countEl) {
                countEl.textContent = safelist.size;
                if (safelist.size > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // =====================================================================
        // DOM ELEMENTS
        // =====================================================================
        const safetyHeader = document.getElementById('safety-header');
        const safetyIcon = document.getElementById('safety-icon');
        const safetyTitle = document.getElementById('safety-title');
        const safetyDesc = document.getElementById('safety-desc');
        const practiceToggle = document.getElementById('practice-toggle');
        const scanForm = document.getElementById('scan-form');
        const queryInput = document.getElementById('query-input');
        const scanBtn = document.getElementById('scan-btn');
        const scanBtnText = document.getElementById('scan-btn-text');
        const scanBtnSpinner = document.getElementById('scan-btn-spinner');
        const alertContainer = document.getElementById('alert-container');
        const folderSelect = document.getElementById('folder-select');
        const keywordSearchForm = document.getElementById('keyword-search-form');
        const keywordInput = document.getElementById('keyword-input');
        const keywordSearchBtn = document.getElementById('keyword-search-btn');
        const keywordBtnText = document.getElementById('keyword-btn-text');
        const keywordBtnSpinner = document.getElementById('keyword-btn-spinner');
        const searchOverlay = document.getElementById('search-overlay');
        const overlayClose = document.getElementById('overlay-close');
        const overlayTotalCount = document.getElementById('overlay-total-count');
        const overlaySenderCount = document.getElementById('overlay-sender-count');
        // Simple Master Checkboxes
        const masterTrashCb = document.getElementById('master-trash-cb');
        const masterSafeCb = document.getElementById('master-safe-cb');
        const overlayTrashBtn = document.getElementById('overlay-trash-btn');
        const overlayTrashBtnMobile = document.getElementById('overlay-trash-btn-mobile');
        const overlayTrashBtnText = document.getElementById('overlay-trash-btn-text');
        const overlaySelectedInfo = document.getElementById('overlay-selected-info');
        const overlaySelectedMobile = document.getElementById('overlay-selected-mobile');
        const overlaySenderList = document.getElementById('overlay-sender-list');
        const overlayAlert = document.getElementById('overlay-alert');
        const previewModal = document.getElementById('preview-modal');
        const modalClose = document.getElementById('modal-close');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalSubject = document.getElementById('modal-subject');
        const modalFrom = document.getElementById('modal-from');
        const modalDate = document.getElementById('modal-date');
        const modalLoading = document.getElementById('modal-loading');
        const modalContent = document.getElementById('modal-content');
        const modalTextContent = document.getElementById('modal-text-content');
        const modalText = document.getElementById('modal-text');
        const modalError = document.getElementById('modal-error');
        const modalTrashBtn = document.getElementById('modal-trash-btn');
        const emailIframe = document.getElementById('email-iframe');
        const upgradeModal = document.getElementById('upgrade-modal');
        const deletionOverlay = document.getElementById('deletion-overlay');
        const deletionTitle = document.getElementById('deletion-title');
        const deletionMessage = document.getElementById('deletion-message');
        const deletionProgress = document.getElementById('deletion-progress');
        const deletionCount = document.getElementById('deletion-count');
        const suggestionForm = document.getElementById('suggestion-form');
        const suggestionText = document.getElementById('suggestion-text');
        const suggestionStatus = document.getElementById('suggestion-status');
        const suggestionBtn = document.getElementById('suggestion-btn');

        // Mode Toggle & Big Select All elements
        const modeControlBar = document.getElementById('mode-control-bar');
        const liveModeToggle = document.getElementById('live-mode-toggle');
        const modeLabelPractice = document.getElementById('mode-label-practice');
        const modeLabelLive = document.getElementById('mode-label-live');
        const toggleInstruction = document.getElementById('toggle-instruction');
        // Select All checkbox (now inline in control bar)

        // =====================================================================
        // MODE TOGGLE (Practice/Live) - HTML CHECKBOX WIRED
        // =====================================================================
        function updateModeUI() {
            const isLive = liveModeToggle.checked;

            if (isLive) {
                // LIVE MODE - Bright Red background
                modeControlBar.classList.add('live-mode');
                modeLabelPractice.classList.add('inactive');
                modeLabelLive.classList.remove('inactive');
                // Update instruction text
                if (toggleInstruction) toggleInstruction.textContent = 'Click here to toggle Practice mode on ——————>';
                // Update Execute buttons - BRIGHT RED
                overlayTrashBtnText.textContent = 'MOVE TO TRASH';
                overlayTrashBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                overlayTrashBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                overlayTrashBtnMobile.textContent = 'TRASH';
                overlayTrashBtnMobile.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                overlayTrashBtnMobile.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                // PRACTICE MODE - Dark Gray background
                modeControlBar.classList.remove('live-mode');
                modeLabelPractice.classList.remove('inactive');
                modeLabelLive.classList.add('inactive');
                // Update instruction text
                if (toggleInstruction) toggleInstruction.textContent = 'Click here to toggle Live mode on ——————>';
                // Update Execute buttons - GRAY for Practice
                overlayTrashBtnText.textContent = 'Run Simulation';
                overlayTrashBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                overlayTrashBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                overlayTrashBtnMobile.textContent = 'Simulate';
                overlayTrashBtnMobile.classList.remove('bg-red-600', 'hover:bg-red-700');
                overlayTrashBtnMobile.classList.add('bg-gray-600', 'hover:bg-gray-700');
            }

            // Sync with global practiceMode
            practiceMode = !isLive;
            practiceToggle.checked = practiceMode;
            updateSafetyUI();
        }

        // Wire up the HTML checkbox toggle
        liveModeToggle.addEventListener('change', updateModeUI);

        // =====================================================================
        // HELPERS
        // =====================================================================
        const avatarColors = ['from-red-500 to-pink-500', 'from-blue-500 to-cyan-500', 'from-green-500 to-emerald-500', 'from-purple-500 to-violet-500', 'from-amber-500 to-orange-500'];
        function getAvatarColor(email) { let h = 0; for (let i = 0; i < email.length; i++) h = email.charCodeAt(i) + ((h << 5) - h); return avatarColors[Math.abs(h) % avatarColors.length]; }
        function getInitials(email) { return (email.split('@')[0][0] || '?').toUpperCase(); }
        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function formatDate(d) { if (!d) return ''; try { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); } catch { return ''; } }

        // Convert Gmail labelIds to a single primary label badge
        function getLabelBadge(labels) {
            if (!labels || !labels.length) return '';

            // Priority order for displaying primary label (most informative first)
            const labelMap = {
                'CATEGORY_PROMOTIONS': { name: 'Promo', class: 'label-promotions' },
                'CATEGORY_SOCIAL': { name: 'Social', class: 'label-social' },
                'CATEGORY_UPDATES': { name: 'Updates', class: 'label-updates' },
                'CATEGORY_FORUMS': { name: 'Forums', class: 'label-forums' },
                'SPAM': { name: 'Spam', class: 'label-spam' },
                'TRASH': { name: 'Trash', class: 'label-trash' },
                'DRAFT': { name: 'Draft', class: 'label-draft' },
                'SENT': { name: 'Sent', class: 'label-sent' },
                'STARRED': { name: 'Star', class: 'label-starred' },
                'IMPORTANT': { name: 'Important', class: 'label-important' },
                'INBOX': { name: 'Inbox', class: 'label-inbox' },
            };

            // Find the first matching label in priority order
            for (const [labelId, info] of Object.entries(labelMap)) {
                if (labels.includes(labelId)) {
                    return `<span class="label-badge ${info.class}">${info.name}</span>`;
                }
            }

            // Check for "CATEGORY_PERSONAL" which means Primary tab
            if (labels.includes('CATEGORY_PERSONAL')) {
                return `<span class="label-badge label-inbox">Primary</span>`;
            }

            // If only has UNREAD or nothing recognizable, show Archive (not in any folder)
            if (!labels.includes('INBOX') && !labels.includes('SPAM') && !labels.includes('TRASH')) {
                return `<span class="label-badge label-default">Archive</span>`;
            }

            return '';
        }
        function showAlert(msg, type = 'info', container = alertContainer) {
            const colors = { success: 'bg-green-500/10 border-green-500/30 text-green-400', error: 'bg-red-500/10 border-red-500/30 text-red-400', warning: 'bg-amber-500/10 border-amber-500/30 text-amber-400', info: 'bg-blue-500/10 border-blue-500/30 text-blue-400' };
            container.innerHTML = `<div class="px-4 py-3 rounded-xl border ${colors[type]} fade-in">${escapeHtml(msg)}</div>`;
        }
        function showUpgradeModal(msg) { document.getElementById('upgrade-modal-message').textContent = msg || "Upgrade for unlimited."; upgradeModal.classList.remove('hidden'); }
        function closeUpgradeModal() { upgradeModal.classList.add('hidden'); }

        // =====================================================================
        // GAS GAUGE FUNCTIONS
        // =====================================================================
        const gaugeOverlay = document.getElementById('gauge-overlay');
        const gaugeArc = document.getElementById('gauge-arc');
        const gaugeNeedle = document.getElementById('gauge-needle');
        const gaugePercent = document.getElementById('gauge-percent');
        const gaugeStatusText = document.getElementById('gauge-status-text');
        const gaugeStatusSub = document.getElementById('gauge-status-sub');

        const GAUGE_ARC_LENGTH = 345; // Total arc length
        let gaugeInterval = null;
        let currentGaugePercent = 0;
        let gaugeCallback = null;  // Stored callback for when gauge completes
        let gaugeReady = false;    // Flag: fetch has returned, complete to 100%

        function showGauge() {
            currentGaugePercent = 0;
            gaugeCallback = null;
            gaugeReady = false;
            // Reset gauge to starting position
            gaugeArc.classList.remove('completing');
            gaugeNeedle.classList.remove('completing');
            gaugeArc.style.strokeDashoffset = GAUGE_ARC_LENGTH;
            gaugeArc.style.stroke = '#ef4444'; // Red
            gaugeNeedle.style.transform = 'rotate(-90deg)';
            gaugePercent.textContent = '0%';
            gaugeStatusText.textContent = 'Scanning your inbox...';
            gaugeStatusSub.textContent = 'Parallel processing active';
            gaugeOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            // Reset results reveal animation for next search
            overlaySenderList.classList.remove('results-reveal');

            // Two speeds: slow while waiting, fast once fetch returns
            const SLOW_SPEED = 0.35;  // ~4.5s to reach 95%
            const FAST_SPEED = 2.0;   // Quick finish once data ready
            const animateGauge = () => {
                // If fetch returned, go to 100% fast; otherwise crawl to 95%
                const maxPercent = gaugeReady ? 100 : 95;
                const speed = gaugeReady ? FAST_SPEED : SLOW_SPEED;

                if (currentGaugePercent < maxPercent) {
                    currentGaugePercent = Math.min(maxPercent, currentGaugePercent + speed);
                    updateGauge(currentGaugePercent);
                    gaugeInterval = requestAnimationFrame(animateGauge);
                } else if (currentGaugePercent >= 100) {
                    // Hit 100% - show results immediately
                    gaugeStatusText.textContent = 'Done!';
                    gaugeStatusSub.textContent = '';
                    hideGauge();
                    if (gaugeCallback) {
                        try { gaugeCallback(); } catch (e) { console.error('Gauge callback error:', e); }
                    }
                } else {
                    // At 95%, waiting for fetch - keep animation loop alive
                    gaugeInterval = requestAnimationFrame(animateGauge);
                }
            };
            gaugeInterval = requestAnimationFrame(animateGauge);
        }

        function updateGauge(percent) {
            percent = Math.min(100, Math.max(0, percent));
            currentGaugePercent = percent;

            // Update arc fill
            const offset = GAUGE_ARC_LENGTH - (GAUGE_ARC_LENGTH * percent / 100);
            gaugeArc.style.strokeDashoffset = offset;

            // Color gradient: red (0%) -> yellow (50%) -> green (100%)
            let color;
            if (percent < 50) {
                const ratio = percent / 50;
                const r = 239;
                const g = Math.round(68 + ratio * (200 - 68));
                const b = Math.round(68 - ratio * 68);
                color = `rgb(${r}, ${g}, ${b})`;
            } else {
                const ratio = (percent - 50) / 50;
                const r = Math.round(239 - ratio * (239 - 34));
                const g = Math.round(200 + ratio * (197 - 200));
                const b = Math.round(0 + ratio * 94);
                color = `rgb(${r}, ${g}, ${b})`;
            }
            gaugeArc.style.stroke = color;

            // Rotate needle (-90deg at 0%, +90deg at 100%)
            const rotation = -90 + (percent * 1.8);
            gaugeNeedle.style.transform = `rotate(${rotation}deg)`;

            // Update percentage text
            gaugePercent.textContent = Math.round(percent) + '%';

            // Update status text at milestones
            if (percent > 90) {
                gaugeStatusText.textContent = 'Almost done!';
            } else if (percent > 60) {
                gaugeStatusText.textContent = 'Processing results...';
            } else if (percent > 30) {
                gaugeStatusText.textContent = 'Grouping by sender...';
            }
        }

        function completeGauge(callback) {
            // Store callback and set flag - animation continues at same speed to 100%
            gaugeCallback = callback;
            gaugeReady = true;
        }

        function hideGauge() {
            cancelAnimationFrame(gaugeInterval);
            gaugeOverlay.classList.add('hidden');
            gaugeOverlay.querySelector('.gauge-container').classList.remove('gauge-pop');
            gaugeArc.classList.remove('glow-pulse', 'completing');
            gaugeNeedle.classList.remove('completing');
            document.body.style.overflow = '';
        }

        // =====================================================================
        // SAFETY MODE
        // =====================================================================
        function updateSafetyUI() {
            const trashIcon = document.getElementById('overlay-trash-icon');
            if (practiceMode) {
                safetyHeader.classList.remove('safety-header-live');
                safetyHeader.classList.add('safety-header-practice');
                safetyIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>';
                safetyTitle.textContent = 'PRACTICE MODE';
                safetyDesc.textContent = 'Safe to explore - nothing will be moved';
                overlayTrashBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                overlayTrashBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                overlayTrashBtnText.textContent = 'Simulate';
                overlayTrashBtnMobile.classList.remove('bg-red-600');
                overlayTrashBtnMobile.classList.add('bg-blue-600');
                // Play icon for simulate
                if (trashIcon) trashIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>';
            } else {
                safetyHeader.classList.remove('safety-header-practice');
                safetyHeader.classList.add('safety-header-live');
                safetyIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
                safetyTitle.textContent = 'LIVE MODE';
                safetyDesc.textContent = 'Emails will be moved to Trash';
                overlayTrashBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                overlayTrashBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                overlayTrashBtnText.textContent = 'Trash Selected';
                overlayTrashBtnMobile.classList.remove('bg-blue-600');
                overlayTrashBtnMobile.classList.add('bg-red-600');
                // Trash icon
                if (trashIcon) trashIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>';
            }
        }

        practiceToggle.addEventListener('change', () => {
            practiceMode = practiceToggle.checked;
            updateSafetyUI();
            if (!practiceMode) showAlert('Live Mode: Items will be moved to Gmail Trash (recoverable for 30 days)', 'warning', overlayAlert);
            else overlayAlert.innerHTML = '';
        });

        // =====================================================================
        // DELETION OVERLAY
        // =====================================================================
        function showDeletionOverlay(total, isSim) {
            deletionTitle.textContent = isSim ? 'Simulating...' : 'Moving to Trash...';
            deletionMessage.textContent = isSim ? 'No emails will be moved.' : 'Please wait...';
            deletionProgress.style.width = '0%';
            deletionCount.textContent = `0 of ${total}`;
            deletionOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        function updateDeletionProgress(p, t) { deletionProgress.style.width = Math.min(100, Math.round((p / t) * 100)) + '%'; deletionCount.textContent = `${p} of ${t}`; }
        function hideDeletionOverlay() { deletionOverlay.classList.add('hidden'); document.body.style.overflow = ''; }

        // =====================================================================
        // STATS UPDATE
        // =====================================================================
        function updateStatsAfterDeletion(n) {
            const t = document.getElementById('stat-total');
            const c = document.getElementById('stat-cleaned');
            const s = document.getElementById('stat-storage');
            if (t) { const v = parseInt(t.textContent.replace(/,/g, '')) || 0; t.textContent = Math.max(0, v - n).toLocaleString(); t.classList.add('text-green-400'); setTimeout(() => t.classList.remove('text-green-400'), 1000); }
            if (c) { const v = parseInt(c.textContent.replace(/,/g, '')) || 0; c.textContent = (v + n).toLocaleString(); c.classList.add('text-primary-400'); setTimeout(() => c.classList.remove('text-primary-400'), 1000); }
            if (s) { const v = parseFloat(s.textContent) || 0; s.textContent = Math.max(0, v - n * 0.075).toFixed(1) + 'MB'; }
        }

        // =====================================================================
        // FILTER COUNTS (Parallel from backend)
        // =====================================================================
        // Store total counts for truth bar display
        const filterTotals = {};

        async function loadFilterCounts() {
            try {
                console.log('%c[SYNC v4.0] FETCHING HARD SYNC COUNTS...', 'color: #ff9800; font-weight: bold; font-size: 16px;');
                const r = await fetch('/api/filter-counts?v=4.0-HARDSYNC&bust=' + Date.now());
                const d = await r.json();

                // Show version verification - MUST BE v4.0-HARDSYNC
                console.log('%c' + '='.repeat(60), 'color: #ff9800;');
                console.log('%c[SYNC v4.0] API VERSION: ' + (d.version || 'GHOST CODE RUNNING!'), 'color: #ff9800; font-weight: bold; font-size: 18px;');
                console.log('%c[SYNC v4.0] TIMESTAMP: ' + (d.timestamp || 'NO TIMESTAMP - GHOST!'), 'color: #ff9800; font-weight: bold;');
                console.log('%c' + '='.repeat(60), 'color: #ff9800;');
                console.log('[SYNC v4.0] Full Response:', d);

                if (d.error) {
                    console.error('[SYNC] API Error:', d.error);
                    return;
                }

                if (d.counts) {
                    console.log('%c[SYNC v4.0] GMAIL LABEL COUNTS (labels().get()):', 'color: #4caf50; font-weight: bold; font-size: 14px;');
                    for (const [f, c] of Object.entries(d.counts)) {
                        filterTotals[f] = c;
                        console.log(`%c  [SYNC] ${f.toUpperCase()}: ${c}`, 'color: #4caf50;');
                        const b = document.querySelector(`[data-count="${f}"]`);
                        if (b) {
                            b.classList.remove('loading', 'bg-gray-700', 'text-gray-400');
                            if (c > 0) {
                                b.classList.add('bg-primary-500/20', 'text-primary-400');
                                // Show "X Total" format for inbox
                                b.textContent = f === 'inbox' ? `${c.toLocaleString()} Total` : c.toLocaleString();
                            }
                            else { b.classList.add('bg-gray-700/50', 'text-gray-500'); b.textContent = '0'; }
                            b.classList.add('count-up');
                        }
                    }
                }
                const fl = document.getElementById('filters-loading');
                if (fl) fl.textContent = '';
            } catch (e) {
                console.error('[SYNC] Fetch failed:', e);
            }
        }

        // =====================================================================
        // OVERLAY
        // =====================================================================
        function openSearchOverlay() {
            searchOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            overlaySenderList.scrollTop = 0;
            window.scrollTo(0, 0);
            // Sync mode toggle with global practiceMode
            liveModeToggle.checked = !practiceMode;
            updateModeUI();
            // Reset master checkboxes
            if (masterTrashCb) masterTrashCb.checked = false;
            if (masterSafeCb) masterSafeCb.checked = false;
            updateSafetyUI();
            updateSafelistUI();
            console.log('[OVERLAY] Search overlay opened');
        }
        function closeSearchOverlay() {
            searchOverlay.classList.add('hidden');
            document.body.style.overflow = '';
            overlayAlert.innerHTML = '';
            // Refresh stats when closing
            loadFilterCounts();
        }
        overlayClose.addEventListener('click', closeSearchOverlay);

        function renderSenderRow(email, data, index) {
            const c = document.createElement('div');
            c.className = 'row-fade-in border-b border-gray-800/30';
            // Staggered animation delay (max 0.5s to prevent long waits)
            c.style.animationDelay = `${Math.min(index * 0.04, 0.5)}s`;
            c.dataset.senderEmail = email;
            const msgs = data.messages || [];
            const allIds = data.ids || [];

            // VAULT SEGREGATION: Filter out vaulted items from display
            const nonVaultedMsgs = msgs.filter(msg => !safelist.has(msg.id));
            const nonVaultedIds = allIds.filter(id => !safelist.has(id));
            const vaultedCount = allIds.length - nonVaultedIds.length;

            // If ALL messages are vaulted, skip this sender entirely
            if (nonVaultedIds.length === 0) {
                c.innerHTML = ''; // Empty - will be skipped
                c.classList.add('hidden');
                return c;
            }

            // Check initial states from safelist (for non-vaulted items)
            const keepCount = nonVaultedIds.filter(id => safelist.has(id)).length;
            const initialState = keepCount === nonVaultedIds.length ? 'keep' : keepCount > 0 ? 'mixed' : '';
            const rowClass = initialState === 'keep' ? 'gm-row-keep' : initialState === 'mixed' ? 'gm-row-mixed' : '';

            // Check if sender matches protected keywords
            const matchedKeyword = matchesProtectedKeyword('', email);
            const protectedBadge = matchedKeyword ? `<span class="ml-2 px-2 py-0.5 text-xs bg-amber-500/20 text-amber-400 rounded-full border border-amber-500/30">Protected: ${escapeHtml(matchedKeyword)}</span>` : '';

            c.innerHTML = `
                <div class="gm-row ${rowClass}" data-sender-idx="${index}">
                    <!-- LEFT: Master Remove Checkbox -->
                    <div class="gm-master">
                        <input type="checkbox" class="gm-checkbox gm-master-check" data-sender-idx="${index}" title="Select all from ${escapeHtml(email)} for removal">
                    </div>
                    <!-- CENTER: Sender Info (clickable to expand) -->
                    <div class="gm-sender" data-sender-idx="${index}">
                        <div class="gm-avatar bg-gradient-to-br ${getAvatarColor(email)}">${getInitials(email)}</div>
                        <div class="gm-info">
                            <div class="gm-email">${escapeHtml(email)}${protectedBadge}</div>
                            <div class="gm-count">${nonVaultedMsgs.length} email${nonVaultedMsgs.length !== 1 ? 's' : ''}${vaultedCount > 0 ? ` <span class="text-green-400">(${vaultedCount} in vault)</span>` : ''} - click to expand</div>
                        </div>
                        <svg class="gm-expand w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                    <!-- RIGHT: Summary -->
                    <div class="gm-summary" data-sender-idx="${index}">—</div>
                </div>
                <div class="message-list hidden bg-dark-900/30" data-sender-idx="${index}">
                    ${nonVaultedMsgs.map((msg, mi) => {
                        const isKept = safelist.has(msg.id);
                        const isMarked = markedForRemoval.has(msg.id);
                        const msgClass = isKept ? 'gm-msg-keep' : isMarked ? 'gm-msg-remove' : '';
                        // Determine status text
                        const statusText = isKept ? 'Safe' : isMarked ? 'Trash' : '';
                        const statusClass = isKept ? 'status-safe' : isMarked ? 'status-trash' : 'status-none';
                        // Check if message subject matches protected keywords
                        const msgKeyword = matchesProtectedKeyword(msg.subject, email);
                        const msgProtectedIcon = msgKeyword ? `<span class="text-amber-400 text-xs mr-1" title="Protected keyword: ${escapeHtml(msgKeyword)}"><svg class="w-4 h-4 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></span>` : '';
                        return `
                        <div class="gm-msg ${msgClass}" data-msg-id="${msg.id}" data-protected-keyword="${msgKeyword || ''}">
                            <div class="gm-msg-content">
                                ${getLabelBadge(msg.labels)}
                                ${msgProtectedIcon}
                                <span class="flex-1 text-sm text-gray-300 truncate">${escapeHtml(msg.subject)}</span>
                                <span class="text-xs text-gray-600 shrink-0">${formatDate(msg.date)}</span>
                                <button class="preview-btn" data-id="${msg.id}">Preview</button>
                            </div>
                            <!-- Checkboxes on RIGHT - plain, no labels -->
                            <div class="gm-msg-controls">
                                <input type="checkbox" class="plain-checkbox trash-check gm-msg-remove" data-msg-id="${msg.id}" data-sender-idx="${index}" ${isMarked ? 'checked' : ''} title="Trash">
                                <input type="checkbox" class="plain-checkbox safe-check gm-msg-keep" data-msg-id="${msg.id}" data-sender-idx="${index}" ${isKept ? 'checked' : ''} title="Vault">
                            </div>
                            <!-- Large status on FAR RIGHT -->
                            <span class="msg-status ${statusClass}" data-msg-id="${msg.id}">${statusText}</span>
                        </div>`;
                    }).join('')}
                    ${msgs.length > 10 ? `<div class="gm-msg text-xs text-gray-500 justify-center">Showing first 10 of ${msgs.length}</div>` : ''}
                </div>`;
            return c;
        }

        // Track which individual messages are marked for removal (by ID)
        let markedForRemoval = new Set();

        // Update row visual state based on child checkbox states
        function updateRowState(container) {
            const row = container.querySelector('.gm-row');
            const summary = container.querySelector('.gm-summary');
            const idx = row?.dataset.senderIdx;
            if (!row || !summary || idx === undefined) return;

            const email = senderEmails[idx];
            const allIds = senderData[email]?.ids || [];

            // Count states
            let removeCount = 0, keepCount = 0;
            allIds.forEach(id => {
                if (markedForRemoval.has(id)) removeCount++;
                else if (safelist.has(id)) keepCount++;
            });

            // Clear row classes
            row.classList.remove('gm-row-remove', 'gm-row-keep', 'gm-row-mixed');
            summary.classList.remove('gm-summary-remove', 'gm-summary-keep', 'gm-summary-mixed');

            if (removeCount === allIds.length) {
                row.classList.add('gm-row-remove');
                summary.classList.add('gm-summary-remove');
                summary.textContent = `${removeCount} Trash`;
            } else if (keepCount === allIds.length) {
                row.classList.add('gm-row-keep');
                summary.classList.add('gm-summary-keep');
                summary.textContent = `${keepCount} Saved`;
            } else if (removeCount > 0 || keepCount > 0) {
                row.classList.add('gm-row-mixed');
                summary.classList.add('gm-summary-mixed');
                const parts = [];
                if (removeCount > 0) parts.push(`${removeCount} Trash`);
                if (keepCount > 0) parts.push(`${keepCount} Saved`);
                summary.textContent = parts.join(', ');
            } else {
                summary.textContent = '—';
            }
        }

        // Update Safety Vault display - Enhanced with persistent storage support
        function updateVaultDisplay() {
            const vaultList = document.getElementById('untouchable-list');
            const vaultCount = document.getElementById('vault-count');
            const vaultCountNum = document.getElementById('vault-count-num');
            if (!vaultList) return;

            const savedIds = Array.from(safelist);

            // Update count badge
            if (vaultCount) {
                if (vaultCountNum) {
                    vaultCountNum.textContent = savedIds.length;
                } else {
                    vaultCount.innerHTML = `<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>${savedIds.length} protected`;
                }
            }

            // Update floating badge
            updateFloatingVaultBadge();

            if (savedIds.length === 0) {
                vaultList.innerHTML = `
                    <p class="text-sm text-gray-500 italic py-4 text-center flex flex-col items-center">
                        <svg class="w-8 h-8 text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        No items in vault yet. Click the green checkbox on any email to protect it.
                    </p>`;
            } else {
                // Show saved items with locked icon - CLICKABLE to preview
                let html = savedIds.slice(0, 10).map(id => {
                    // Find the message info if available from current scan or stored metadata
                    let subject = vaultMetadata[id]?.subject || 'Protected email';
                    let sender = vaultMetadata[id]?.sender || '';
                    let addedAt = vaultMetadata[id]?.addedAt ? new Date(vaultMetadata[id].addedAt).toLocaleDateString() : '';

                    // Try to get live data from current scan
                    for (const email in senderData) {
                        const msg = senderData[email].messages?.find(m => m.id === id);
                        if (msg) {
                            subject = msg.subject || 'No subject';
                            sender = email;
                            // Update metadata with latest info
                            if (vaultMetadata[id]) {
                                vaultMetadata[id].subject = subject;
                                vaultMetadata[id].sender = sender;
                            }
                            break;
                        }
                    }
                    return `
                        <div class="flex items-center justify-between p-3 bg-green-900/20 rounded-lg border border-green-500/30 hover:bg-green-900/40 transition-colors group">
                            <div class="flex items-center space-x-3 flex-1 min-w-0 cursor-pointer vault-preview-btn" data-id="${id}" title="Click to preview">
                                <div class="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <span class="text-sm text-white font-medium truncate block">${escapeHtml(subject)}</span>
                                    ${sender ? `<span class="text-xs text-gray-500 truncate block">${escapeHtml(sender)}</span>` : ''}
                                </div>
                                <span class="text-xs text-green-400 opacity-0 group-hover:opacity-100 transition-opacity">Preview</span>
                            </div>
                            <button class="release-vault-btn ml-3 px-3 py-1.5 text-xs text-red-400/70 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-all border border-transparent hover:border-red-500/30" data-msg-id="${id}">
                                Release
                            </button>
                        </div>`;
                }).join('');

                if (savedIds.length > 10) {
                    html += `
                        <div class="flex items-center justify-center py-2">
                            <button id="view-all-vault" class="text-sm text-green-400 hover:text-green-300 font-medium flex items-center space-x-2">
                                <span>View all ${savedIds.length} protected items</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        </div>`;
                }
                vaultList.innerHTML = html;

                // Bind "View All" button
                const viewAllBtn = document.getElementById('view-all-vault');
                if (viewAllBtn) {
                    viewAllBtn.addEventListener('click', openVaultSanctuary);
                }

                // Add release button handlers
                vaultList.querySelectorAll('.release-vault-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const msgId = btn.dataset.msgId;
                        removeFromVault(msgId);
                        // Update any visible checkbox
                        const keepCb = document.querySelector(`.gm-msg-keep[data-msg-id="${msgId}"]`);
                        if (keepCb) keepCb.checked = false;
                        const msgRow = document.querySelector(`.gm-msg[data-msg-id="${msgId}"]`);
                        if (msgRow) {
                            const container = msgRow.closest('[data-sender-email]');
                            updateMsgRowState(msgRow, msgId);
                            if (container) updateRowState(container);
                        }
                    });
                });

                // Add preview click handlers for vault items
                vaultList.querySelectorAll('.vault-preview-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const msgId = btn.dataset.id;
                        if (msgId) openPreview(msgId);
                    });
                });
            }

            // Save metadata updates directly (avoid recursive loop with saveSafelist)
            const vaultData = { ids: Array.from(safelist), metadata: vaultMetadata, lastUpdated: new Date().toISOString() };
            localStorage.setItem('mailremover_vault', JSON.stringify(vaultData));
        }

        // =====================================================================
        // VAULT SANCTUARY MODAL
        // =====================================================================
        function openVaultSanctuary() {
            const modal = document.getElementById('vault-sanctuary-modal');
            const sanctuaryList = document.getElementById('sanctuary-list');
            const sanctuaryEmpty = document.getElementById('sanctuary-empty');
            const sanctuaryCount = document.getElementById('sanctuary-count');

            if (!modal) return;

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            const savedIds = Array.from(safelist);
            sanctuaryCount.textContent = `${savedIds.length} item${savedIds.length !== 1 ? 's' : ''}`;

            if (savedIds.length === 0) {
                sanctuaryEmpty.classList.remove('hidden');
                sanctuaryList.classList.add('hidden');
            } else {
                sanctuaryEmpty.classList.add('hidden');
                sanctuaryList.classList.remove('hidden');

                // Render all vault items with full details
                sanctuaryList.innerHTML = savedIds.map((id, idx) => {
                    const meta = vaultMetadata[id] || {};
                    const subject = meta.subject || 'Protected email';
                    const sender = meta.sender || 'Unknown sender';
                    const addedAt = meta.addedAt ? new Date(meta.addedAt).toLocaleString() : 'Unknown';

                    return `
                        <div class="sanctuary-item bg-dark-900/80 rounded-xl border border-green-500/20 hover:border-green-500/40 p-4 transition-all" data-msg-id="${id}">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex items-start space-x-4 flex-1 min-w-0">
                                    <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center flex-shrink-0 mt-1">
                                        <svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="text-white font-semibold text-base truncate">${escapeHtml(subject)}</h4>
                                        <p class="text-gray-400 text-sm truncate">${escapeHtml(sender)}</p>
                                        <p class="text-gray-600 text-xs mt-1">Protected: ${addedAt}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col space-y-2 flex-shrink-0">
                                    <button class="sanctuary-preview-btn px-4 py-2 bg-green-600/20 hover:bg-green-600/40 text-green-400 text-sm font-medium rounded-lg border border-green-500/30 transition-colors" data-id="${id}">
                                        Preview
                                    </button>
                                    <button class="sanctuary-release-btn px-4 py-2 bg-red-600/10 hover:bg-red-600/30 text-red-400 text-sm font-medium rounded-lg border border-red-500/20 hover:border-red-500/40 transition-colors" data-id="${id}">
                                        Release
                                    </button>
                                </div>
                            </div>
                        </div>`;
                }).join('');

                // Bind sanctuary event handlers
                sanctuaryList.querySelectorAll('.sanctuary-preview-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const msgId = btn.dataset.id;
                        if (msgId) openPreview(msgId);
                    });
                });

                sanctuaryList.querySelectorAll('.sanctuary-release-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const msgId = btn.dataset.id;
                        if (msgId) {
                            removeFromVault(msgId);
                            // Refresh sanctuary view
                            openVaultSanctuary();
                        }
                    });
                });
            }
        }

        function closeVaultSanctuary() {
            const modal = document.getElementById('vault-sanctuary-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        // Bind sanctuary modal buttons
        document.addEventListener('DOMContentLoaded', () => {
            const openSanctuaryBtn = document.getElementById('open-vault-sanctuary');
            const closeSanctuaryBtn = document.getElementById('close-sanctuary');
            const closeSanctuaryEmptyBtn = document.getElementById('sanctuary-close-empty');
            const floatingVaultBtn = document.getElementById('floating-vault-btn');
            const sanctuaryModal = document.getElementById('vault-sanctuary-modal');

            if (openSanctuaryBtn) openSanctuaryBtn.addEventListener('click', openVaultSanctuary);
            if (closeSanctuaryBtn) closeSanctuaryBtn.addEventListener('click', closeVaultSanctuary);
            if (closeSanctuaryEmptyBtn) closeSanctuaryEmptyBtn.addEventListener('click', closeVaultSanctuary);
            if (floatingVaultBtn) floatingVaultBtn.addEventListener('click', openVaultSanctuary);

            // Close on backdrop click
            if (sanctuaryModal) {
                sanctuaryModal.addEventListener('click', (e) => {
                    if (e.target === sanctuaryModal || e.target.classList.contains('bg-black/95')) {
                        closeVaultSanctuary();
                    }
                });
            }

            // Initialize vault display
            updateVaultDisplay();
            updateFloatingVaultBadge();
        });

        // Update message row visual state AND status text
        function updateMsgRowState(msgRow, msgId) {
            msgRow.classList.remove('gm-msg-remove', 'gm-msg-keep');
            const statusSpan = msgRow.querySelector('.msg-status');

            if (markedForRemoval.has(msgId)) {
                msgRow.classList.add('gm-msg-remove');
                if (statusSpan) {
                    statusSpan.textContent = 'Trash';
                    statusSpan.className = 'msg-status status-trash';
                }
            } else if (safelist.has(msgId)) {
                msgRow.classList.add('gm-msg-keep');
                if (statusSpan) {
                    statusSpan.textContent = 'Safe';
                    statusSpan.className = 'msg-status status-safe';
                }
            } else {
                if (statusSpan) {
                    statusSpan.textContent = '';
                    statusSpan.className = 'msg-status status-none';
                }
            }
        }

        function bindSenderListeners() {
            // MASTER CHECKBOX - Inherits to all children
            document.querySelectorAll('.gm-master-check').forEach(masterCb => {
                masterCb.addEventListener('change', () => {
                    const idx = parseInt(masterCb.dataset.senderIdx);
                    const email = senderEmails[idx];
                    const container = masterCb.closest('[data-sender-email]');
                    const allIds = senderData[email]?.ids || [];

                    // Get all child checkboxes
                    const msgRemoves = container.querySelectorAll('.gm-msg-remove');
                    const msgKeeps = container.querySelectorAll('.gm-msg-keep');

                    if (masterCb.checked) {
                        // Master checked = mark all for removal (unless individually overridden to Keep)
                        allIds.forEach(id => {
                            if (!safelist.has(id)) {
                                markedForRemoval.add(id);
                            }
                        });
                        // Update child checkboxes
                        msgRemoves.forEach(cb => {
                            const msgId = cb.dataset.msgId;
                            if (!safelist.has(msgId)) {
                                cb.checked = true;
                                const msgRow = cb.closest('.gm-msg');
                                if (msgRow) updateMsgRowState(msgRow, msgId);
                            }
                        });
                    } else {
                        // Master unchecked = remove all from removal list
                        allIds.forEach(id => markedForRemoval.delete(id));
                        msgRemoves.forEach(cb => {
                            cb.checked = false;
                            const msgId = cb.dataset.msgId;
                            const msgRow = cb.closest('.gm-msg');
                            if (msgRow) updateMsgRowState(msgRow, msgId);
                        });
                    }

                    updateRowState(container);
                    updateSelectionInfo();
                });
            });

            // INDIVIDUAL REMOVE CHECKBOX
            document.querySelectorAll('.gm-msg-remove').forEach(cb => {
                cb.addEventListener('change', () => {
                    const msgId = cb.dataset.msgId;
                    const container = cb.closest('[data-sender-email]');
                    const msgRow = cb.closest('.gm-msg');
                    const keepCb = msgRow?.querySelector('.gm-msg-keep');

                    if (cb.checked) {
                        markedForRemoval.add(msgId);
                        safelist.delete(msgId); // Can't be both
                        if (keepCb) keepCb.checked = false;
                    } else {
                        markedForRemoval.delete(msgId);
                    }

                    updateMsgRowState(msgRow, msgId);
                    updateRowState(container);
                    updateMasterCheckbox(container);
                    saveSafelist();
                    updateSelectionInfo();
                });
            });

            // INDIVIDUAL SAVE (VAULT) CHECKBOX - stores metadata for persistence
            document.querySelectorAll('.gm-msg-keep').forEach(cb => {
                cb.addEventListener('change', () => {
                    const msgId = cb.dataset.msgId;
                    const container = cb.closest('[data-sender-email]');
                    const senderEmail = container?.dataset.senderEmail || '';
                    const msgRow = cb.closest('.gm-msg');
                    const removeCb = msgRow?.querySelector('.gm-msg-remove');

                    // Get message subject from the row
                    const subjectEl = msgRow?.querySelector('.gm-msg-content .truncate');
                    const subject = subjectEl?.textContent || 'Unknown subject';

                    if (cb.checked) {
                        // Add to vault with metadata for persistence
                        addToVault(msgId, { subject, sender: senderEmail });
                        markedForRemoval.delete(msgId); // Can't be both
                        if (removeCb) removeCb.checked = false;
                    } else {
                        // Remove from vault
                        removeFromVault(msgId);
                    }

                    updateMsgRowState(msgRow, msgId);
                    updateRowState(container);
                    updateMasterCheckbox(container);
                    updateSelectionInfo();
                });
            });

            // Sender click - expand/collapse messages
            document.querySelectorAll('.gm-sender').forEach(el => {
                el.addEventListener('click', () => {
                    const idx = el.dataset.senderIdx;
                    const list = document.querySelector(`.message-list[data-sender-idx="${idx}"]`);
                    const expand = el.querySelector('.gm-expand');
                    if (list) {
                        list.classList.toggle('hidden');
                        expand?.classList.toggle('open');
                    }
                });
            });

            // Preview buttons
            document.querySelectorAll('.preview-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openPreview(btn.dataset.id);
                });
            });
        }

        // Update master checkbox state based on children
        function updateMasterCheckbox(container) {
            const masterCb = container.querySelector('.gm-master-check');
            const idx = masterCb?.dataset.senderIdx;
            if (!masterCb || idx === undefined) return;

            const email = senderEmails[idx];
            const allIds = senderData[email]?.ids || [];
            const removeCount = allIds.filter(id => markedForRemoval.has(id)).length;

            masterCb.checked = removeCount > 0 && removeCount === allIds.filter(id => !safelist.has(id)).length;
            masterCb.indeterminate = removeCount > 0 && removeCount < allIds.filter(id => !safelist.has(id)).length;
        }

        // Update selection info to show BOTH trash and saved counts
        function updateSelectionInfo() {
            const trashCount = markedForRemoval.size;
            const saveCount = safelist.size;
            overlayTrashBtn.disabled = trashCount === 0;
            overlayTrashBtnMobile.disabled = trashCount === 0;
            // Show both counts in one line
            let infoText = `${trashCount.toLocaleString()} for Trash`;
            if (saveCount > 0) infoText += ` · ${saveCount.toLocaleString()} Safe`;
            overlaySelectedInfo.textContent = infoText;
            overlaySelectedMobile.textContent = trashCount.toLocaleString();
        }

        // ====== AUTO-EXPAND ALL ROWS ======
        function expandAllRows() {
            document.querySelectorAll('.message-list.hidden').forEach(list => {
                list.classList.remove('hidden');
                const idx = list.dataset.senderIdx;
                const expand = document.querySelector(`.gm-sender[data-sender-idx="${idx}"] .gm-expand`);
                if (expand) expand.classList.add('open');
            });
        }

        // ====== MASTER TRASH CHECKBOX - Toggle with Priority Override ======
        masterTrashCb?.addEventListener('change', () => {
            const isChecked = masterTrashCb.checked;
            console.log('[MASTER TRASH]', isChecked ? 'Checked' : 'Unchecked');

            // Uncheck the other master checkbox (mutually exclusive)
            if (isChecked && masterSafeCb) masterSafeCb.checked = false;

            // Get all message IDs
            const allMsgIds = [];
            senderEmails.forEach(email => {
                const ids = senderData[email]?.ids || [];
                ids.forEach(id => allMsgIds.push(id));
            });

            if (isChecked) {
                // PRIORITY OVERRIDE: Clear saves, mark all for trash
                allMsgIds.forEach(id => {
                    safelist.delete(id);
                    markedForRemoval.add(id);
                });
            } else {
                // Uncheck all trash
                allMsgIds.forEach(id => {
                    markedForRemoval.delete(id);
                });
            }
            saveSafelist();

            // Update all visible UI elements
            document.querySelectorAll('.gm-msg').forEach(msgRow => {
                const trashCb = msgRow.querySelector('.gm-msg-remove');
                const saveCb = msgRow.querySelector('.gm-msg-keep');
                if (trashCb) trashCb.checked = isChecked;
                if (saveCb) saveCb.checked = false;
                msgRow.classList.remove('gm-msg-keep', 'gm-msg-remove');
                if (isChecked) msgRow.classList.add('gm-msg-remove');
            });

            // Update parent row states
            document.querySelectorAll('[data-sender-email]').forEach(container => {
                updateRowState(container);
            });

            // Auto-expand to show Data Truth
            expandAllRows();
            updateSelectionInfo();
            updateVaultDisplay();
        });

        // ====== MASTER SAFE CHECKBOX - Toggle with Priority Override ======
        masterSafeCb?.addEventListener('change', () => {
            const isChecked = masterSafeCb.checked;
            console.log('[MASTER SAFE]', isChecked ? 'Checked' : 'Unchecked');

            // Uncheck the other master checkbox (mutually exclusive)
            if (isChecked && masterTrashCb) masterTrashCb.checked = false;

            // Get all message IDs
            const allMsgIds = [];
            senderEmails.forEach(email => {
                const ids = senderData[email]?.ids || [];
                ids.forEach(id => allMsgIds.push(id));
            });

            if (isChecked) {
                // PRIORITY OVERRIDE: Clear trash, mark all for save
                allMsgIds.forEach(id => {
                    markedForRemoval.delete(id);
                    safelist.add(id);
                });
            } else {
                // Uncheck all safe
                allMsgIds.forEach(id => {
                    safelist.delete(id);
                });
            }
            saveSafelist();

            // Update all visible UI elements
            document.querySelectorAll('.gm-msg').forEach(msgRow => {
                const trashCb = msgRow.querySelector('.gm-msg-remove');
                const saveCb = msgRow.querySelector('.gm-msg-keep');
                if (saveCb) saveCb.checked = isChecked;
                if (trashCb) trashCb.checked = false;
                msgRow.classList.remove('gm-msg-keep', 'gm-msg-remove');
                if (isChecked) msgRow.classList.add('gm-msg-keep');
            });

            // Update parent row states
            document.querySelectorAll('[data-sender-email]').forEach(container => {
                updateRowState(container);
            });

            // Auto-expand to show Data Truth
            expandAllRows();
            updateSelectionInfo();
            updateVaultDisplay();
        });

        // =====================================================================
        // SCAN (with safelist exclusion + gauge animation)
        // =====================================================================
        async function performScan(query, isKeyword = false) {
            currentQuery = query;
            senderData = {};
            senderEmails = [];
            selectedSenders.clear();
            markedForRemoval.clear();

            // Show gauge immediately
            showGauge();

            try {
                const formData = new FormData();
                formData.append('query', query);
                // Send safelist IDs to exclude from results
                safelist.forEach(id => formData.append('exclude_ids', id));

                const r = await fetch('/scan', { method: 'POST', body: formData });
                const d = await r.json();

                if (!r.ok) {
                    hideGauge();
                    throw new Error(d.error || 'Scan failed');
                }

                // Complete gauge and show results immediately
                completeGauge(() => {
                    // ALWAYS open the modal, even for 0 results
                    senderData = d.sender_data || {};
                    senderEmails = Object.keys(senderData);
                    const fetchedCount = d.count || 0;
                    const totalEstimate = d.total_estimate || fetchedCount;

                    overlayTotalCount.textContent = fetchedCount.toLocaleString();
                    overlaySenderCount.textContent = senderEmails.length;

                    // Show batch status note if we hit the limit
                    const batchNote = document.getElementById('batch-status-note');
                    const batchText = document.getElementById('batch-status-text');
                    if (batchNote && batchText) {
                        if (totalEstimate > fetchedCount) {
                            batchText.textContent = `Showing first ${fetchedCount.toLocaleString()} of ~${totalEstimate.toLocaleString()} total. Move these to Trash to reveal more.`;
                            batchNote.classList.remove('hidden');
                        } else {
                            batchNote.classList.add('hidden');
                        }
                    }

                    // DATA TRUTH: Show thread vs message comparison
                    const dataTruthModule = document.getElementById('data-truth-module');
                    const threadCount = d.thread_count || 0;
                    if (dataTruthModule && threadCount > 0) {
                        document.getElementById('gmail-thread-count').textContent = threadCount.toLocaleString();
                        document.getElementById('our-message-count').textContent = totalEstimate.toLocaleString();

                        // Show ratio if messages > threads (hidden data found)
                        const ratioEl = document.getElementById('data-truth-ratio');
                        if (totalEstimate > threadCount && ratioEl) {
                            const hiddenPercent = Math.round(((totalEstimate - threadCount) / threadCount) * 100);
                            ratioEl.textContent = `(+${hiddenPercent}% hidden data)`;
                            ratioEl.classList.remove('hidden');
                        } else if (ratioEl) {
                            ratioEl.classList.add('hidden');
                        }

                        dataTruthModule.classList.remove('hidden');
                    } else if (dataTruthModule) {
                        dataTruthModule.classList.add('hidden');
                    }

                    overlaySenderList.innerHTML = '';

                    if (d.count === 0 || senderEmails.length === 0) {
                        // Empty state UI
                        overlaySenderList.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-16 px-6 text-center fade-in">
                                <div class="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mb-6">
                                    <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-semibold text-white mb-2">No Matching Emails Found</h3>
                                <p class="text-gray-400 max-w-sm">
                                    ${isKeyword
                                        ? `No emails contain "<span class="text-primary-400">${escapeHtml(query.replace(/"/g, '').replace(' in:anywhere', ''))}</span>".`
                                        : 'Your inbox is looking great! Try a different search or filter.'}
                                </p>
                                <button onclick="closeSearchOverlay()" class="mt-6 px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl transition-colors">
                                    Try Another Search
                                </button>
                            </div>`;
                    } else {
                        // Normal results
                        senderEmails.forEach((email, i) => {
                            overlaySenderList.appendChild(renderSenderRow(email, senderData[email], i));
                        });
                        bindSenderListeners();
                    }

                    // Reset master checkbox states
                    if (masterTrashCb) masterTrashCb.checked = false;
                    if (masterSafeCb) masterSafeCb.checked = false;

                    // Clean up stale safelist IDs that don't exist in current scan
                    const currentIds = new Set();
                    senderEmails.forEach(email => {
                        (senderData[email]?.ids || []).forEach(id => currentIds.add(id));
                    });
                    const staleIds = [...safelist].filter(id => !currentIds.has(id));
                    if (staleIds.length > 0) {
                        console.log('[SAFELIST CLEANUP] Removing', staleIds.length, 'stale IDs from previous sessions');
                        staleIds.forEach(id => safelist.delete(id));
                        saveSafelist();
                    }

                    updateSelectionInfo();
                    updateVaultDisplay();
                    openSearchOverlay();

                    console.log('[SCAN COMPLETE] Results displayed:', senderEmails.length, 'senders');
                });

                return d.count > 0;
            } catch (e) {
                hideGauge();
                showAlert(e.message, 'error');
                return false;
            }
        }

        folderSelect.addEventListener('change', async () => {
            const v = folderSelect.value;
            if (v) {
                queryInput.value = v;
                scanBtn.disabled = true;
                scanBtnText.textContent = 'Scanning...';
                scanBtnSpinner.classList.remove('hidden');
                await performScan(v);
                scanBtn.disabled = false;
                scanBtnText.textContent = 'Scan';
                scanBtnSpinner.classList.add('hidden');
            }
        });

        scanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = queryInput.value.trim();
            if (!q) return;
            scanBtn.disabled = true;
            scanBtnText.textContent = 'Scanning...';
            scanBtnSpinner.classList.remove('hidden');
            await performScan(q);
            scanBtn.disabled = false;
            scanBtnText.textContent = 'Scan';
            scanBtnSpinner.classList.add('hidden');
        });

        keywordSearchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const kw = keywordInput.value.trim();
            if (!kw) return;
            const gmailQuery = `"${kw}" in:anywhere`;
            queryInput.value = gmailQuery;
            keywordSearchBtn.disabled = true;
            keywordBtnText.textContent = 'Searching...';
            keywordBtnSpinner.classList.remove('hidden');
            await performScan(gmailQuery, true);
            keywordSearchBtn.disabled = false;
            keywordBtnText.textContent = 'Search All';
            keywordBtnSpinner.classList.add('hidden');
        });

        // Map queries to friendly names for results header
        const filterNames = {
            'in:inbox': 'Inbox',
            'is:starred': 'Starred',
            'in:sent': 'Sent',
            'in:drafts': 'Drafts',
            'category:purchases': 'Purchases',
            'is:unread': 'Unread',
            'category:updates': 'Updates',
            'category:promotions': 'Promotions',
            'in:spam': 'Spam'
        };

        document.querySelectorAll('.filter-card').forEach(card => {
            card.addEventListener('click', async () => {
                const q = card.dataset.query;
                const filterName = filterNames[q] || 'Results';

                // Set results header based on filter
                const resultsHeader = document.getElementById('results-header');
                if (resultsHeader) {
                    if (q === 'in:inbox' && filterTotals.inbox) {
                        resultsHeader.textContent = `Inbox (${filterTotals.inbox.toLocaleString()} Total)`;
                    } else {
                        resultsHeader.textContent = `Showing ${filterName}`;
                    }
                }

                queryInput.value = q;
                folderSelect.value = '';
                scanBtn.disabled = true;
                scanBtnText.textContent = 'Scanning...';
                scanBtnSpinner.classList.remove('hidden');
                await performScan(q);
                scanBtn.disabled = false;
                scanBtnText.textContent = 'Scan';
                scanBtnSpinner.classList.add('hidden');
            });
        });

        // =====================================================================
        // CLICKABLE STAT BADGES
        // =====================================================================
        const resultsHeader = document.getElementById('results-header');
        const badgeTotal = document.getElementById('badge-total');

        badgeTotal?.addEventListener('click', async () => {
            resultsHeader.textContent = 'Showing All Mail';
            queryInput.value = 'in:anywhere';
            folderSelect.value = '';
            scanBtn.disabled = true;
            scanBtnText.textContent = 'Scanning...';
            scanBtnSpinner.classList.remove('hidden');
            await performScan('in:anywhere');
            scanBtn.disabled = false;
            scanBtnText.textContent = 'Scan';
            scanBtnSpinner.classList.add('hidden');
        });

        // =====================================================================
        // TRASH - WITH KEYWORD FIREWALL PROTECTION
        // =====================================================================
        async function doTrash() {
            // Use markedForRemoval directly - it already contains individual message IDs
            // VAULT SEGREGATION: Filter out any vaulted items that somehow got marked
            const ids = Array.from(markedForRemoval).filter(id => !safelist.has(id));
            if (!ids.length) { showAlert('No emails selected for removal.', 'warning', overlayAlert); return; }

            // KEYWORD FIREWALL: Check if any selected emails match protected keywords
            const protectedEmails = [];
            document.querySelectorAll('.gm-msg').forEach(msgRow => {
                const msgId = msgRow.dataset.msgId;
                const protectedKeyword = msgRow.dataset.protectedKeyword;
                if (msgId && markedForRemoval.has(msgId) && protectedKeyword) {
                    protectedEmails.push({ id: msgId, keyword: protectedKeyword });
                }
            });

            // If there are protected emails, show warning
            if (protectedEmails.length > 0 && protectedKeywordsList.length > 0) {
                const uniqueKeywords = [...new Set(protectedEmails.map(e => e.keyword))];
                const keywordList = uniqueKeywords.slice(0, 3).join(', ') + (uniqueKeywords.length > 3 ? '...' : '');

                // Show keyword warning modal
                return new Promise((resolve) => {
                    showKeywordWarning(keywordList, (action) => {
                        if (action === 'vault') {
                            // Add all protected emails to vault
                            protectedEmails.forEach(({ id }) => {
                                const msgData = findMessageData(id);
                                addToVault(id, { subject: msgData?.subject, sender: msgData?.sender });
                                markedForRemoval.delete(id);
                            });
                            // Update UI
                            document.querySelectorAll('.gm-msg').forEach(msgRow => {
                                const msgId = msgRow.dataset.msgId;
                                if (protectedEmails.some(e => e.id === msgId)) {
                                    updateMsgRowState(msgRow, msgId);
                                    const container = msgRow.closest('[data-sender-email]');
                                    if (container) updateRowState(container);
                                }
                            });
                            updateSelectionInfo();
                            showAlert(`${protectedEmails.length} emails added to Vault instead of Trash.`, 'success', overlayAlert);
                            resolve();
                        } else if (action === 'proceed') {
                            // Proceed with trash
                            proceedWithTrash(ids);
                            resolve();
                        } else {
                            resolve();
                        }
                    });
                });
            }

            await proceedWithTrash(ids);
        }

        // Helper to find message data from senderData
        function findMessageData(msgId) {
            for (const email in senderData) {
                const msg = senderData[email].messages?.find(m => m.id === msgId);
                if (msg) return { subject: msg.subject, sender: email };
            }
            return null;
        }

        async function proceedWithTrash(ids) {
            const count = Math.min(ids.length, MAX_IDS);
            const action = practiceMode ? 'simulate trashing' : 'move to Trash';
            if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} ${count.toLocaleString()} emails?`)) return;

            await trashEmails(ids.slice(0, MAX_IDS));
        }

        overlayTrashBtn.addEventListener('click', doTrash);
        overlayTrashBtnMobile.addEventListener('click', doTrash);

        async function trashEmails(ids) {
            const total = ids.length;
            overlayTrashBtn.disabled = true;
            overlayTrashBtnMobile.disabled = true;
            overlayTrashBtnText.textContent = practiceMode ? 'Simulating...' : 'Moving to Trash...';

            showDeletionOverlay(total, practiceMode);

            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90;
                updateDeletionProgress(Math.floor(total * progress / 100), total);
            }, 150);

            try {
                const r = await fetch('/trash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_ids: ids, dry_run: practiceMode, query: currentQuery })
                });
                const d = await r.json();

                clearInterval(interval);
                updateDeletionProgress(total, total);
                await new Promise(res => setTimeout(res, 400));
                hideDeletionOverlay();

                if (r.status === 402) { showUpgradeModal(d.message); return; }
                if (!r.ok) throw new Error(d.error || 'Failed');

                showAlert(d.message, practiceMode ? 'info' : 'success', overlayAlert);

                if (!practiceMode && d.trashed > 0) {
                    // Trigger HIGH-VELOCITY animation on confirmed trash
                    if (typeof triggerTrashAnimation === 'function') {
                        triggerTrashAnimation(ids);
                    }
                    updateStatsAfterDeletion(d.trashed);
                    // Delay overlay close to let animation play
                    setTimeout(() => {
                        closeSearchOverlay();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 500);
                }
            } catch (e) {
                clearInterval(interval);
                hideDeletionOverlay();
                showAlert(e.message, 'error', overlayAlert);
            } finally {
                updateSafetyUI();
                updateSelectionInfo();
            }
        }

        // =====================================================================
        // PREVIEW
        // =====================================================================
        let currentPreviewId = null;

        function openPreview(id) {
            currentPreviewId = id;
            modalLoading.classList.remove('hidden');
            modalContent.classList.add('hidden');
            modalTextContent.classList.add('hidden');
            modalError.classList.add('hidden');
            modalSubject.textContent = 'Loading...';
            modalFrom.textContent = '';
            modalDate.textContent = '';
            previewModal.classList.remove('hidden');

            fetch(`/message/${id}`)
                .then(r => r.json())
                .then(d => {
                    if (d.error) throw new Error(d.error);
                    modalSubject.textContent = d.subject;
                    modalFrom.textContent = d.from;
                    modalDate.textContent = formatDate(d.date);
                    modalLoading.classList.add('hidden');
                    if (d.body_type === 'html') {
                        emailIframe.srcdoc = `<!DOCTYPE html><html><head><base target="_blank"><style>body{font-family:system-ui;font-size:14px;color:#333;margin:16px;}img{max-width:100%;}</style></head><body>${d.body}

</body></html>`;
                        modalContent.classList.remove('hidden');
                    } else {
                        modalText.textContent = d.body;
                        modalTextContent.classList.remove('hidden');
                    }
                })
                .catch(() => { modalLoading.classList.add('hidden'); modalError.classList.remove('hidden'); });
        }

        function closePreviewModal() { previewModal.classList.add('hidden'); currentPreviewId = null; }
        modalClose.addEventListener('click', closePreviewModal);
        modalCloseBtn.addEventListener('click', closePreviewModal);
        document.getElementById('modal-backdrop').addEventListener('click', closePreviewModal);
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closePreviewModal(); closeSearchOverlay(); } });

        modalTrashBtn.addEventListener('click', async () => {
            if (!currentPreviewId) return;
            if (!confirm(practiceMode ? 'Simulate moving to Trash?' : 'Move to Trash? (Recoverable for 30 days)')) return;
            modalTrashBtn.disabled = true;
            modalTrashBtn.textContent = 'Processing...';
            try {
                const r = await fetch('/trash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_ids: [currentPreviewId], dry_run: practiceMode })
                });
                const d = await r.json();
                if (r.status === 402) { closePreviewModal(); showUpgradeModal(d.message); return; }
                closePreviewModal();
                showAlert(d.message, practiceMode ? 'info' : 'success', overlayAlert);
                if (!practiceMode && d.trashed > 0) updateStatsAfterDeletion(d.trashed);
            } catch (e) { showAlert(e.message, 'error', overlayAlert); }
            finally { modalTrashBtn.disabled = false; modalTrashBtn.textContent = 'Trash'; }
        });

        // =====================================================================
        // SUGGESTIONS
        // =====================================================================
        suggestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const t = suggestionText.value.trim();
            if (!t) { suggestionStatus.textContent = 'Please enter something.'; suggestionStatus.className = 'text-sm text-red-400'; return; }
            suggestionBtn.disabled = true;
            suggestionBtn.textContent = 'Sending...';
            try {
                const r = await fetch('/api/suggestion', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ suggestion: t }) });
                const d = await r.json();
                if (!r.ok) throw new Error(d.error);
                suggestionText.value = '';
                suggestionStatus.textContent = 'Thank you!';
                suggestionStatus.className = 'text-sm text-green-400';
                setTimeout(() => suggestionStatus.textContent = '', 4000);
            } catch (e) { suggestionStatus.textContent = e.message; suggestionStatus.className = 'text-sm text-red-400'; }
            finally { suggestionBtn.disabled = false; suggestionBtn.textContent = 'Submit'; }
        });

        // =====================================================================
        // INIT
        // =====================================================================
        checkProviderUrlParam();
        initProviderUI();
        loadFilterCounts();
        updateSafetyUI();
        updateSafelistUI();
        updateVaultDisplay();
        updateFloatingVaultBadge();
        console.log('[VAULT] Initialized with', safelist.size, 'protected items');

        // Sync animation toggle with stored preference
        (function initAnimationToggle() {
            const toggle = document.getElementById('animation-toggle');
            if (toggle && window.AnimationSystem) {
                toggle.checked = AnimationSystem.isEnabled();
            }
        })();

        /**
         * Initialize provider UI based on session state
         */
        function initProviderUI() {
            console.log(`[PROVIDER] Primary: ${primaryProvider}`);
            console.log(`[PROVIDER] Connected:`, connectedProviders);

            // Update page header to show current provider
            const pageHeader = document.querySelector('h1');
            if (pageHeader && primaryProvider !== 'gmail') {
                const providerName = primaryProvider.charAt(0).toUpperCase() + primaryProvider.slice(1);
                pageHeader.innerHTML = `MailRemover <span class="text-sm font-normal text-primary-400">(${providerName})</span>`;
            }

            // Show provider-specific empty state if no stats
            if (primaryProvider === 'yahoo') {
                const stats = getProviderStats('yahoo');
                if (stats && stats.placeholder) {
                    showYahooPlaceholder();
                }
            }
        }

        /**
         * Show status UI for Yahoo when it's the primary provider
         */
        function showYahooPlaceholder() {
            // Yahoo is now connected via OAuth - no placeholder needed
            // Stats will be fetched from the Yahoo API when fully integrated
            console.log('Yahoo Mail connected via OAuth');
        }

        // =====================================================================
        // AJAX POLLING - Silent auto-refresh every 60 seconds
        // =====================================================================
        let lastKnownTotal = parseInt(document.getElementById('stat-total')?.textContent) || 0;
        let lastKnownInbox = parseInt(document.getElementById('stat-inbox')?.textContent) || 0;
        let lastKnownLatestId = null;
        let pollingInterval = null;

        async function checkForUpdates() {
            try {
                // Get current provider from URL params or use primaryProvider
                const urlParams = new URLSearchParams(window.location.search);
                const currentProvider = urlParams.get('provider') || primaryProvider || 'gmail';

                // Pass provider to lock the poll to the selected provider
                const response = await fetch(`/api/check_updates?provider=${currentProvider}`);
                if (!response.ok) return;

                const data = await response.json();
                if (data.error) {
                    console.log(`[POLL] Error for ${currentProvider}:`, data.error);
                    return;
                }

                // Verify we got data for the correct provider
                if (data.provider && data.provider !== currentProvider) {
                    console.warn(`[POLL] Provider mismatch: expected ${currentProvider}, got ${data.provider}`);
                    return;
                }

                console.log(`[POLL] ${currentProvider} stats: total=${data.total}, unread=${data.unread}`);

                const newTotal = data.total || 0;
                const newInbox = data.inbox || data.unread || 0;
                const newLatestId = data.latest_id;

                const hasChanges = (
                    newTotal !== lastKnownTotal ||
                    newInbox !== lastKnownInbox ||
                    (newLatestId && newLatestId !== lastKnownLatestId)
                );

                if (hasChanges) {
                    const statTotal = document.getElementById('stat-total');
                    const statInbox = document.getElementById('stat-inbox');

                    if (statTotal && newTotal !== lastKnownTotal) {
                        statTotal.textContent = newTotal.toLocaleString();
                        statTotal.classList.add('count-up');
                        setTimeout(() => statTotal.classList.remove('count-up'), 300);
                    }

                    if (statInbox && newInbox !== lastKnownInbox) {
                        statInbox.textContent = newInbox.toLocaleString();
                        statInbox.classList.add('count-up');
                        setTimeout(() => statInbox.classList.remove('count-up'), 300);
                    }

                    const statStorage = document.getElementById('stat-storage');
                    if (statStorage) {
                        statStorage.textContent = Math.round(newTotal * 0.075) + 'MB';
                    }

                    lastKnownTotal = newTotal;
                    lastKnownInbox = newInbox;
                    lastKnownLatestId = newLatestId;

                    loadFilterCounts();
                }
            } catch (e) { /* Silent fail */ }
        }

        function startPolling() {
            setTimeout(checkForUpdates, 5000);
            pollingInterval = setInterval(checkForUpdates, 60000);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
            } else {
                if (!pollingInterval) { checkForUpdates(); startPolling(); }
            }
        });

        startPolling();

        // =====================================================================
        // WELCOME MODAL - FIRST-TIME USER ONBOARDING
        // =====================================================================
        const welcomeModal = document.getElementById('welcome-modal');
        const welcomeSlides = document.querySelectorAll('.welcome-slide');
        const welcomeDots = document.querySelectorAll('.welcome-dot');
        const welcomeNext = document.getElementById('welcome-next');
        const welcomePrev = document.getElementById('welcome-prev');
        const welcomeSkip = document.getElementById('welcome-skip');
        let currentSlide = 0;

        function showSlide(idx) {
            welcomeSlides.forEach((s, i) => {
                s.classList.toggle('hidden', i !== idx);
                s.classList.toggle('fade-in', i === idx);
            });
            welcomeDots.forEach((d, i) => {
                d.classList.toggle('bg-primary-500', i === idx);
                d.classList.toggle('bg-gray-600', i !== idx);
            });
            welcomePrev.classList.toggle('hidden', idx === 0);
            welcomeNext.textContent = idx === 2 ? 'Get Started' : 'Next';
            currentSlide = idx;
        }

        function closeWelcome() {
            welcomeModal.classList.add('hidden');
            localStorage.setItem('mailremover_welcomed', 'true');
        }

        if (welcomeModal) {
            welcomeNext.addEventListener('click', () => {
                if (currentSlide < 2) showSlide(currentSlide + 1);
                else closeWelcome();
            });
            welcomePrev.addEventListener('click', () => {
                if (currentSlide > 0) showSlide(currentSlide - 1);
            });
            welcomeSkip.addEventListener('click', closeWelcome);
            welcomeDots.forEach((d, i) => d.addEventListener('click', () => showSlide(i)));

            // Show for first-time users
            if (!localStorage.getItem('mailremover_welcomed')) {
                welcomeModal.classList.remove('hidden');
                showSlide(0);
            }
        }

        // =====================================================================
        // PROTECTION PANEL - SMART SAFETY CHECKBOXES (PERSISTENT)
        // =====================================================================
        const safetyCheckboxes = document.querySelectorAll('.safety-checkbox');
        const customProtectInput = document.getElementById('custom-protect-keyword');
        const addProtectBtn = document.getElementById('add-protect-keyword');
        const protectedKeywordsListEl = document.getElementById('protected-keywords-list');
        const wipeSessionBtn = document.getElementById('wipe-session-btn');

        // Protected keywords storage (localStorage for persistence!)
        // Sync with the global protectedKeywordsList variable
        let protectedKeywords = protectedKeywordsList;

        function saveProtectedKeywords() {
            localStorage.setItem('mailremover_keywords', JSON.stringify(protectedKeywords));
            // Sync global variable
            protectedKeywordsList = protectedKeywords;
        }

        function renderProtectedKeywords() {
            if (!protectedKeywordsListEl) return;
            protectedKeywordsListEl.innerHTML = protectedKeywords.map((kw, idx) => `
                <span class="inline-flex items-center px-3 py-1.5 bg-green-600/20 text-green-400 text-sm rounded-lg border border-green-600/30 hover:bg-green-600/30 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    ${escapeHtml(kw)}
                    <button type="button" class="ml-2 text-green-400 hover:text-red-400 transition-colors" onclick="removeProtectedKeyword(${idx})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </span>
            `).join('');
        }

        function addProtectedKeyword(keyword) {
            if (!keyword || keyword.trim() === '') return;
            const trimmed = keyword.trim();
            if (!protectedKeywords.includes(trimmed)) {
                protectedKeywords.push(trimmed);
                saveProtectedKeywords();
                renderProtectedKeywords();
                showAlert(`Added "${trimmed}" to protected keywords - emails with this keyword will trigger a warning before trashing.`, 'success');
            }
        }

        window.removeProtectedKeyword = function(idx) {
            const removed = protectedKeywords[idx];
            protectedKeywords.splice(idx, 1);
            saveProtectedKeywords();
            renderProtectedKeywords();
        };

        // Safety checkbox handlers (use localStorage for persistence)
        if (safetyCheckboxes) {
            safetyCheckboxes.forEach(cb => {
                const keyword = cb.dataset.keyword;
                // Restore checked state from localStorage
                const savedState = localStorage.getItem(`protect_${cb.id}`);
                if (savedState === 'true') {
                    cb.checked = true;
                    if (keyword && !protectedKeywords.includes(keyword)) {
                        protectedKeywords.push(keyword);
                    }
                }

                cb.addEventListener('change', () => {
                    localStorage.setItem(`protect_${cb.id}`, cb.checked);
                    if (cb.checked && keyword) {
                        addProtectedKeyword(keyword);
                    } else if (!cb.checked && keyword) {
                        const idx = protectedKeywords.indexOf(keyword);
                        if (idx > -1) {
                            protectedKeywords.splice(idx, 1);
                            saveProtectedKeywords();
                            renderProtectedKeywords();
                        }
                    }
                });
            });
        }

        // Custom keyword add button
        if (addProtectBtn) {
            addProtectBtn.addEventListener('click', () => {
                addProtectedKeyword(customProtectInput.value);
                customProtectInput.value = '';
            });
        }
        if (customProtectInput) {
            customProtectInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addProtectedKeyword(customProtectInput.value);
                    customProtectInput.value = '';
                }
            });
        }

        // Purge Temporary Vault button - clears browser cache only
        const purgeVaultBtn = document.getElementById('purge-vault-btn');
        if (purgeVaultBtn) {
            purgeVaultBtn.addEventListener('click', () => {
                // Show confirmation modal
                showPurgeVaultModal();
            });
        }

        function showPurgeVaultModal() {
            const modal = document.createElement('div');
            modal.id = 'purge-vault-modal';
            modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-dark-900 rounded-2xl border border-gray-700 max-w-md w-full mx-4 shadow-2xl overflow-hidden pop-in">
                    <div class="p-6 border-b border-gray-800">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-slate-500/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Purge Temporary Vault</h3>
                                <p class="text-sm text-gray-400">Clear locally cached scan data</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                            <p class="text-sm text-blue-200 leading-relaxed">
                                <strong class="text-white">What this does:</strong><br>
                                Removes AI-analyzed email snippets and scan metadata stored in your browser.
                            </p>
                        </div>
                        <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                            <p class="text-sm text-green-200 leading-relaxed">
                                <strong class="text-white">What this does NOT do:</strong><br>
                                Your original emails in Gmail are <strong>never touched</strong>. This only clears the temporary preview data used for display.
                            </p>
                        </div>
                    </div>
                    <div class="p-6 bg-dark-850 border-t border-gray-800 flex items-center justify-end space-x-3">
                        <button id="purge-cancel" class="px-5 py-2.5 text-gray-400 hover:text-white transition-colors">Cancel</button>
                        <button id="purge-confirm" class="px-6 py-2.5 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg transition-colors">Purge Vault</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Handle cancel
            document.getElementById('purge-cancel').addEventListener('click', () => {
                modal.remove();
            });

            // Handle confirm - purge browser cache only
            document.getElementById('purge-confirm').addEventListener('click', () => {
                // Clear all mailremover session data
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('mailremover') || key.startsWith('protect_')) {
                        sessionStorage.removeItem(key);
                    }
                });
                // Clear local storage except welcome flag
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('mailremover') && key !== 'mailremover_welcomed') {
                        localStorage.removeItem(key);
                    }
                });
                // Reset UI
                protectedKeywords = [];
                renderProtectedKeywords();
                safetyCheckboxes.forEach(cb => cb.checked = false);

                modal.remove();
                showAlert('Temporary vault cleared. Your Gmail emails are safe and untouched!', 'success');
            });

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Secure Sign Out button - clears data and logs out
        if (wipeSessionBtn) {
            wipeSessionBtn.addEventListener('click', () => {
                // Clear all mailremover session data first
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('mailremover') || key.startsWith('protect_')) {
                        sessionStorage.removeItem(key);
                    }
                });
                // Clear local storage except welcome flag
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('mailremover') && key !== 'mailremover_welcomed') {
                        localStorage.removeItem(key);
                    }
                });
                // Redirect to logout
                window.location.href = '/logout';
            });
        }

        // Initial render
        renderProtectedKeywords();

        // ====== VERSION DISPLAY ======
        // Fetch version from version.json and display in footer
        (async function loadVersion() {
            try {
                const response = await fetch('/version.json');
                if (response.ok) {
                    const data = await response.json();
                    const versionEl = document.getElementById('app-version');
                    if (versionEl && data.version) {
                        versionEl.textContent = `v${data.version}`;
                        versionEl.title = `Released: ${data.release_date || 'Unknown'}`;
                    }
                }
            } catch (e) {
                console.log('Version info not available');
            }
        })();

        // ====== PROVIDER STRIP HANDLERS ======
        // Yahoo and Microsoft now use OAuth - no modal needed
        // Click handlers removed to allow direct OAuth redirect

        // ====== YAHOO MODAL FUNCTIONS (Legacy - kept for potential App Password fallback) ======
        const yahooModal = document.getElementById('yahoo-modal');

        function openYahooModal() {
            // Clear previous inputs
            document.getElementById('yahoo-email').value = '';
            document.getElementById('yahoo-app-password').value = '';
            // Reset button states
            resetYahooButtons();
            // Show modal
            yahooModal.classList.remove('hidden');
        }

        function closeYahooModal() {
            yahooModal.classList.add('hidden');
            // Clean up URL if it has the provider param
            const url = new URL(window.location.href);
            if (url.searchParams.has('provider') || url.searchParams.has('open_yahoo_modal')) {
                url.searchParams.delete('provider');
                url.searchParams.delete('open_yahoo_modal');
                window.history.replaceState({}, document.title, url.pathname);
            }
        }

        // Auto-open Yahoo modal if redirected from /login/yahoo
        (function checkYahooModalTrigger() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('provider') === 'yahoo' || urlParams.get('open_yahoo_modal') === 'true') {
                // Small delay to ensure modal elements are ready
                setTimeout(() => {
                    openYahooModal();
                }, 100);
            }
        })();

        function resetYahooButtons() {
            const testBtn = document.getElementById('yahoo-test-btn');
            const connectBtn = document.getElementById('yahoo-connect-btn');
            testBtn.disabled = false;
            testBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Test Connection`;
            connectBtn.disabled = false;
            connectBtn.textContent = 'Connect Yahoo';
        }

        function testYahooConnection() {
            const email = document.getElementById('yahoo-email').value.trim();
            const appPassword = document.getElementById('yahoo-app-password').value.trim();
            const testBtn = document.getElementById('yahoo-test-btn');

            if (!email || !appPassword) {
                showAlert('Please enter both your Yahoo email and App Password.', 'warning');
                return;
            }

            // Show loading state
            testBtn.disabled = true;
            testBtn.innerHTML = `<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Testing...`;

            // Placeholder for actual API call
            // TODO: Implement actual Yahoo IMAP connection test
            setTimeout(() => {
                testBtn.disabled = false;
                testBtn.innerHTML = `<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Test Connection`;
                showAlert('Yahoo connection test coming soon! Backend integration in progress.', 'info');
            }, 1500);
        }

        function connectYahooAccount() {
            const email = document.getElementById('yahoo-email').value.trim();
            const appPassword = document.getElementById('yahoo-app-password').value.trim();
            const connectBtn = document.getElementById('yahoo-connect-btn');

            if (!email || !appPassword) {
                showAlert('Please enter both your Yahoo email and App Password.', 'warning');
                return;
            }

            // Show loading state
            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';

            // Placeholder for actual API call
            // TODO: Implement actual Yahoo account connection
            setTimeout(() => {
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect Yahoo';
                showAlert('Yahoo account connection coming soon! Backend integration in progress.', 'info');
            }, 1500);
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !yahooModal.classList.contains('hidden')) {
                closeYahooModal();
            }
        });

        // =====================================================================
        // HIGH-VELOCITY ANIMATION SYSTEM v1.0
        // =====================================================================
        const AnimationSystem = (function() {
            const config = { enabled: true, vortexDuration: 400, implodeDuration: 300, vaultDuration: 400, maxParticles: 50, batchSize: 20, reducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches };
            let overlay = null;
            function init() {
                if (!overlay) { overlay = document.createElement('div'); overlay.className = 'animation-overlay'; overlay.id = 'animation-overlay'; document.body.appendChild(overlay); }
                const saved = localStorage.getItem('mailremover_animations'); if (saved !== null) config.enabled = saved === 'true';
                window.matchMedia('(prefers-reduced-motion: reduce)').addEventListener('change', e => { config.reducedMotion = e.matches; });
            }
            function shouldAnimate() { return config.enabled && !config.reducedMotion; }
            function toggle(en) { config.enabled = en; localStorage.setItem('mailremover_animations', en); document.body.classList.toggle('animations-disabled', !en); }
            function getCenterPoint(els) {
                if (!els || !els.length) return { x: window.innerWidth / 2, y: window.innerHeight / 2 };
                const vis = els.filter(e => { const r = e.getBoundingClientRect(); return r.top < window.innerHeight && r.bottom > 0; });
                if (!vis.length) return { x: window.innerWidth / 2, y: window.innerHeight / 2 };
                let sx = 0, sy = 0; vis.forEach(e => { const r = e.getBoundingClientRect(); sx += r.left + r.width / 2; sy += r.top + r.height / 2; });
                return { x: sx / vis.length, y: sy / vis.length };
            }
            function createParticles(n, cx, cy, type) {
                const ps = [], colors = type === 'vault' ? ['#4ade80', '#22c55e', '#16a34a'] : ['#f87171', '#ef4444', '#dc2626', '#ea580c'];
                for (let i = 0; i < Math.min(n, config.maxParticles); i++) {
                    const p = document.createElement('div'); p.className = type === 'vault' ? 'vault-particle' : 'vortex-particle';
                    p.style.cssText = `left:${cx + (Math.random() - 0.5) * 100}px;top:${cy + (Math.random() - 0.5) * 100}px;background:${colors[Math.floor(Math.random() * colors.length)]};width:${3 + Math.random() * 4}px;height:${p.style.width};animation:${type === 'vault' ? 'vaultParticleRise' : 'vortexParticle'} ${0.3 + Math.random() * 0.2}s ease-out forwards;animation-delay:${Math.random() * 0.2}s`;
                    ps.push(p);
                }
                return ps;
            }
            function createFragments(cx, cy, n) {
                const fs = [];
                for (let i = 0; i < Math.min(n, 30); i++) {
                    const f = document.createElement('div'); f.className = 'implode-fragment';
                    const a = Math.random() * Math.PI * 2, d = 50 + Math.random() * 100;
                    f.style.cssText = `left:${cx}px;top:${cy}px;--frag-x:${Math.cos(a) * d}px;--frag-y:${Math.sin(a) * d}px;animation:fragmentExplode 0.35s ease-out forwards;animation-delay:${Math.random() * 0.1}s`;
                    fs.push(f);
                }
                return fs;
            }
            function vortex(els, cb) {
                if (!shouldAnimate() || !els || !els.length) { if (cb) cb(); return; }
                const c = getCenterPoint(els);
                const vc = document.createElement('div'); vc.className = 'vortex-center'; vc.style.cssText = `left:${c.x}px;top:${c.y}px`; overlay.appendChild(vc);
                requestAnimationFrame(() => vc.classList.add('active'));
                const ps = createParticles(els.length, c.x, c.y, 'vortex'); ps.forEach(p => overlay.appendChild(p));
                els.forEach((el, i) => { const r = el.getBoundingClientRect(); el.style.setProperty('--vortex-x', (c.x - (r.left + r.width / 2)) + 'px'); el.style.setProperty('--vortex-y', (c.y - (r.top + r.height / 2)) + 'px'); el.style.animationDelay = (i * 0.015) + 's'; el.classList.add('vortex-item'); });
                setTimeout(() => { vc.remove(); ps.forEach(p => p.remove()); els.forEach(el => { el.classList.remove('vortex-item'); el.style.removeProperty('--vortex-x'); el.style.removeProperty('--vortex-y'); el.style.animationDelay = ''; }); if (cb) cb(); }, config.vortexDuration + 150);
            }
            function implode(els, cb) {
                if (!shouldAnimate() || !els || !els.length) { if (cb) cb(); return; }
                const c = getCenterPoint(els);
                const sw = document.createElement('div'); sw.className = 'implode-shockwave'; sw.style.cssText = `left:${c.x}px;top:${c.y}px`; overlay.appendChild(sw);
                els.forEach((el, i) => { const r = el.getBoundingClientRect(); el.style.setProperty('--implode-x', (c.x - (r.left + r.width / 2)) + 'px'); el.style.setProperty('--implode-y', (c.y - (r.top + r.height / 2)) + 'px'); el.style.animationDelay = (i * 0.01) + 's'; el.classList.add('implode-item'); });
                setTimeout(() => { sw.classList.add('active'); const fs = createFragments(c.x, c.y, Math.min(els.length * 2, 30)); fs.forEach(f => overlay.appendChild(f)); setTimeout(() => fs.forEach(f => f.remove()), 400); }, config.implodeDuration - 100);
                setTimeout(() => { sw.remove(); els.forEach(el => { el.classList.remove('implode-item'); el.style.removeProperty('--implode-x'); el.style.removeProperty('--implode-y'); el.style.animationDelay = ''; }); if (cb) cb(); }, config.implodeDuration + 150);
            }
            function vault(els, cb) {
                if (!shouldAnimate() || !els || !els.length) { if (cb) cb(); return; }
                const c = getCenterPoint(els);
                const sh = document.createElement('div'); sh.className = 'vault-shield'; sh.style.cssText = `left:${c.x}px;top:${c.y - 40}px`; sh.innerHTML = '<svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>'; overlay.appendChild(sh);
                const ps = createParticles(els.length, c.x, c.y, 'vault'); ps.forEach(p => overlay.appendChild(p));
                requestAnimationFrame(() => sh.classList.add('active'));
                els.forEach((el, i) => { el.style.animationDelay = (i * 0.025) + 's'; el.classList.add('vault-item'); });
                setTimeout(() => { sh.remove(); ps.forEach(p => p.remove()); els.forEach(el => { el.classList.remove('vault-item'); el.style.animationDelay = ''; }); if (cb) cb(); }, config.vaultDuration + 150);
            }
            function flashItem(el, type) { if (!shouldAnimate() || !el) return; const cls = type === 'trash' ? 'email-row-selected' : 'email-row-saved'; el.classList.add(cls); setTimeout(() => el.classList.remove(cls), 300); }
            init();
            return { vortex, implode, vault, flashItem, toggle, isEnabled: () => config.enabled, shouldAnimate };
        })();
        function triggerTrashAnimation(ids) { if (!ids || !ids.length) return; const els = []; ids.forEach(id => { const el = document.querySelector(`[data-msg-id="${id}"]`); if (el) els.push(el); }); if (!els.length) return; els.length >= 50 ? AnimationSystem.implode(els) : AnimationSystem.vortex(els); }
        function triggerVaultAnimation(ids) { if (!ids || !ids.length) return; const els = []; ids.forEach(id => { const el = document.querySelector(`[data-msg-id="${id}"]`); if (el) els.push(el); }); if (els.length) AnimationSystem.vault(els); }
        window.AnimationSystem = AnimationSystem; window.triggerTrashAnimation = triggerTrashAnimation; window.triggerVaultAnimation = triggerVaultAnimation;
    </script>

    <!-- SAFE-START WALKTHROUGH MODAL -->
    <div id="welcome-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="rounded-2xl" style="background: var(--surface); border: 1px solid var(--border); max-w-md w-full mx-4 shadow-2xl overflow-hidden">
            <!-- Slide 1: SECURE -->
            <div class="welcome-slide p-8 text-center">
                <div class="w-20 h-20 mx-auto mb-6 bg-green-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-green-400 mb-3">SECURE</h3>
                <p class="text-base text-gray-300 leading-relaxed">
                    We use <strong class="text-white">Google OAuth</strong> — we never see your password.
                </p>
            </div>

            <!-- Slide 2: PRIVATE -->
            <div class="welcome-slide p-8 text-center hidden">
                <div class="w-20 h-20 mx-auto mb-6 bg-blue-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-blue-400 mb-3">PRIVATE</h3>
                <p class="text-base text-gray-300 leading-relaxed">
                    We scan for <strong class="text-white">file counts only</strong> — we never read your personal message content.
                </p>
            </div>

            <!-- Slide 3: EASY TO USE -->
            <div class="welcome-slide p-8 text-center hidden">
                <div class="w-20 h-20 mx-auto mb-6 bg-purple-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-purple-400 mb-3">EASY TO USE</h3>
                <p class="text-base text-gray-300 leading-relaxed">
                    One click finds the clutter. <strong class="text-white">You are always in control.</strong>
                </p>
            </div>

            <!-- Navigation -->
            <div class="px-8 pb-6 flex items-center justify-between border-t border-gray-800 pt-4">
                <button id="welcome-skip" class="text-sm text-gray-500 hover:text-gray-300 transition-colors">Skip</button>
                <div class="flex items-center space-x-2">
                    <button class="welcome-dot w-2.5 h-2.5 rounded-full bg-primary-500 transition-colors cursor-pointer"></button>
                    <button class="welcome-dot w-2.5 h-2.5 rounded-full bg-gray-600 transition-colors cursor-pointer"></button>
                    <button class="welcome-dot w-2.5 h-2.5 rounded-full bg-gray-600 transition-colors cursor-pointer"></button>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="welcome-prev" class="text-sm text-gray-400 hover:text-white transition-colors hidden">Back</button>
                    <button id="welcome-next" class="px-5 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-bold rounded-lg transition-colors">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ====== FLOATING VAULT BADGE - ALWAYS VISIBLE (z-[200]) ====== -->
    <div id="floating-vault-badge" class="fixed bottom-6 right-6 z-[200] hidden">
        <button id="floating-vault-btn" class="flex items-center space-x-3 px-5 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold rounded-full shadow-2xl shadow-green-900/50 border-2 border-green-400/50 transition-all hover:scale-105 glow-pulse">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
            <span id="floating-vault-count">0</span>
            <span class="text-sm font-medium">Vaulted</span>
        </button>
    </div>

    <!-- ====== VAULT SANCTUARY MODAL - FULL VIEW OF VAULTED ITEMS ====== -->
    <div id="vault-sanctuary-modal" class="fixed inset-0 z-[150] hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md"></div>
        <div class="absolute inset-0 flex flex-col">
            <!-- Sanctuary Header -->
            <div class="bg-gradient-to-r from-green-900/80 to-emerald-900/80 border-b-2 border-green-500/50 px-6 py-5 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 bg-green-500/20 rounded-2xl flex items-center justify-center border border-green-400/40">
                        <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-green-400 tracking-tight">VAULT SANCTUARY</h2>
                        <p class="text-green-300/80 text-sm">Your protected emails - Safe from ALL actions</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="sanctuary-count" class="text-lg font-bold text-green-400 bg-green-500/20 px-4 py-2 rounded-full border border-green-500/40">0 items</span>
                    <button id="close-sanctuary" class="p-3 text-gray-400 hover:text-white hover:bg-gray-800/50 rounded-xl transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- Sanctuary Info Bar -->
            <div class="bg-green-900/20 border-b border-green-500/20 px-6 py-3">
                <p class="text-sm text-green-200/80">
                    <svg class="w-4 h-4 inline mr-2 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                    Items in this sanctuary are <strong class="text-green-400">100% segregated</strong> from Inbox scans and Trash actions. Data persists across browser sessions.
                </p>
            </div>

            <!-- Sanctuary Content -->
            <div id="sanctuary-content" class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-dark-950/90">
                <div id="sanctuary-empty" class="text-center py-20">
                    <div class="w-24 h-24 mx-auto mb-6 bg-green-500/10 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-green-500/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-400 mb-2">Your Sanctuary is Empty</h3>
                    <p class="text-gray-500 mb-4">Add emails to the vault by clicking the green checkbox on any email.</p>
                    <button id="sanctuary-close-empty" class="px-6 py-2 bg-green-600/30 hover:bg-green-600/50 text-green-400 font-semibold rounded-lg border border-green-500/40 transition-colors">
                        Start Protecting Emails
                    </button>
                </div>
                <div id="sanctuary-list" class="space-y-3 hidden"></div>
            </div>
        </div>
    </div>

    <!-- ====== VAULT RESCUE MODAL ====== -->
    <div id="rescue-modal" class="fixed inset-0 z-[80] hidden">
        <div class="absolute inset-0 bg-black/85 backdrop-blur-sm" id="rescue-backdrop"></div>
        <div class="relative h-full flex items-center justify-center p-4">
            <div class="w-full max-w-2xl rounded-2xl border flex flex-col" style="background: #12121A; border-color: #39FF14; box-shadow: 0 0 40px rgba(57,255,20,0.2); max-height: 85vh;">
                <!-- Header -->
                <div class="flex items-center justify-between p-5 border-b" style="border-color: rgba(57,255,20,0.3);">
                    <div>
                        <h2 class="text-xl font-black text-white flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="#39FF14" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                            <span>Rescue from Trash</span>
                        </h2>
                        <p class="text-sm mt-0.5" style="color: #39FF14;">You never lose anything.</p>
                    </div>
                    <button id="rescue-modal-close" class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <!-- Subheader / controls -->
                <div class="flex items-center justify-between px-5 py-3 border-b" style="border-color: #2A2A35; background: #1A1A24;">
                    <div class="flex items-center space-x-3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="rescue-select-all" class="w-4 h-4 accent-green-500">
                            <span class="text-sm text-gray-300 font-medium">Select All</span>
                        </label>
                        <span id="rescue-selected-count" class="text-xs px-2 py-0.5 rounded-full font-semibold" style="background: rgba(57,255,20,0.15); color: #39FF14;">0 selected</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span id="rescue-total-count" class="text-xs text-gray-500"></span>
                        <button id="rescue-download-btn" disabled
                            class="flex items-center space-x-2 px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                            style="background: #39FF14; color: #000;">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            <span>Download ZIP</span>
                        </button>
                    </div>
                </div>

                <!-- Email list -->
                <div id="rescue-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div id="rescue-loading" class="flex flex-col items-center justify-center py-16 space-y-3">
                        <svg class="animate-spin w-8 h-8" style="color:#39FF14;" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                        <p class="text-sm text-gray-400">Loading Trash...</p>
                    </div>
                    <div id="rescue-empty" class="hidden flex-col items-center justify-center py-16 space-y-3 text-center">
                        <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                        <p class="text-gray-400 font-medium">Trash is empty</p>
                        <p class="text-sm text-gray-600">Nothing to rescue right now.</p>
                    </div>
                    <div id="rescue-items-container" class="hidden space-y-1.5"></div>
                </div>

                <!-- Footer note -->
                <div class="px-5 py-3 border-t text-xs text-gray-500" style="border-color: #2A2A35;">
                    Downloads as a ZIP of .eml files — importable into any email client or stored locally forever.
                </div>
            </div>
        </div>
    </div>

    <script>
    // ====================================================================
    // VAULT RESCUE
    // ====================================================================
    (function() {
        const modal       = document.getElementById('rescue-modal');
        const backdrop    = document.getElementById('rescue-backdrop');
        const closeBtn    = document.getElementById('rescue-modal-close');
        const openBtn     = document.getElementById('open-rescue-modal');
        const selectAll   = document.getElementById('rescue-select-all');
        const dlBtn       = document.getElementById('rescue-download-btn');
        const countBadge  = document.getElementById('rescue-selected-count');
        const totalBadge  = document.getElementById('rescue-total-count');
        const loading     = document.getElementById('rescue-loading');
        const empty       = document.getElementById('rescue-empty');
        const container   = document.getElementById('rescue-items-container');

        let rescueItems = [];

        function openModal() {
            modal.classList.remove('hidden');
            loadTrash();
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function updateSelectionUI() {
            const checked = container.querySelectorAll('.rescue-cb:checked');
            const n = checked.length;
            countBadge.textContent = n + ' selected';
            dlBtn.disabled = n === 0;
            selectAll.indeterminate = n > 0 && n < rescueItems.length;
            selectAll.checked = n === rescueItems.length && n > 0;
        }

        function renderItems(items) {
            loading.classList.add('hidden');
            if (!items || items.length === 0) {
                empty.classList.remove('hidden');
                empty.classList.add('flex');
                return;
            }
            container.classList.remove('hidden');
            totalBadge.textContent = items.length + ' emails in Trash';
            container.innerHTML = items.map(item => {
                const d = item.date ? new Date(item.date).toLocaleDateString() : '';
                const size = item.sizeMB > 0 ? (item.sizeMB < 0.1 ? '<0.1' : item.sizeMB.toFixed(1)) + ' MB' : '';
                return `<label class="flex items-center space-x-3 p-3 rounded-xl cursor-pointer transition-colors group" style="background:#1A1A24; border:1px solid #2A2A35;" onmouseover="this.style.borderColor='rgba(57,255,20,0.4)'" onmouseout="this.style.borderColor=this.querySelector(\'.rescue-cb\').checked ? \'rgba(57,255,20,0.5)\' : \'#2A2A35\'">
                    <input type="checkbox" class="rescue-cb w-4 h-4 accent-green-500 flex-shrink-0" data-id="${item.id}">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">${escapeHtml(item.subject)}</p>
                        <p class="text-xs text-gray-500 truncate">${escapeHtml(item.from)}${d ? ' &middot; ' + d : ''}${size ? ' &middot; ' + size : ''}</p>
                    </div>
                </label>`;
            }).join('');
            container.querySelectorAll('.rescue-cb').forEach(cb => {
                cb.addEventListener('change', updateSelectionUI);
            });
            updateSelectionUI();
        }

        async function loadTrash() {
            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            empty.classList.remove('flex');
            container.classList.add('hidden');
            container.innerHTML = '';
            selectAll.checked = false;
            dlBtn.disabled = true;
            countBadge.textContent = '0 selected';
            totalBadge.textContent = '';
            try {
                const res = await fetch('/api/trash-list');
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to load');
                rescueItems = data.items || [];
                renderItems(rescueItems);
            } catch(e) {
                loading.classList.add('hidden');
                container.classList.remove('hidden');
                container.innerHTML = `<p class="text-red-400 text-sm text-center py-8">Failed to load Trash: ${e.message}</p>`;
            }
        }

        selectAll.addEventListener('change', function() {
            container.querySelectorAll('.rescue-cb').forEach(cb => { cb.checked = this.checked; });
            updateSelectionUI();
        });

        dlBtn.addEventListener('click', async function() {
            const selected = Array.from(container.querySelectorAll('.rescue-cb:checked')).map(cb => cb.dataset.id);
            if (!selected.length) return;
            dlBtn.disabled = true;
            dlBtn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg><span>Preparing...</span>';
            try {
                const res = await fetch('/api/rescue', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message_ids: selected})
                });
                if (!res.ok) throw new Error('Server error');
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mailremover_rescue.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch(e) {
                alert('Download failed: ' + e.message);
            } finally {
                dlBtn.disabled = false;
                dlBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg><span>Download ZIP</span>';
                updateSelectionUI();
            }
        });

        if (openBtn) openBtn.addEventListener('click', openModal);
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (backdrop) backdrop.addEventListener('click', closeModal);
    })();
    </script>

</body>
</html>
